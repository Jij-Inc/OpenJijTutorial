
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>13 Reverse Quantum Annealing with Portfolio Optimization Problem as an example &#8212; OpenJij Tutorial 0.3.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxdoc.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="A1 - OpenJij core interface入門 (core python interface)" href="A001-Introduction.html" />
    <link rel="prev" title="12-Solving Protein Folding Problem by HUBO Solver" href="012-ProteinFoldingHubo.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="A001-Introduction.html" title="A1 - OpenJij core interface入門 (core python interface)"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="012-ProteinFoldingHubo.html" title="12-Solving Protein Folding Problem by HUBO Solver"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">OpenJij Tutorial 0.3.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">OpenJij チュートリアル</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">13 Reverse Quantum Annealing with Portfolio Optimization Problem as an example</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<section id="13-Reverse-Quantum-Annealing-with-Portfolio-Optimization-Problem-as-an-example">
<h1>13 Reverse Quantum Annealing with Portfolio Optimization Problem as an example<a class="headerlink" href="#13-Reverse-Quantum-Annealing-with-Portfolio-Optimization-Problem-as-an-example" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="https://colab.research.google.com/github/OpenJij/OpenJijTutorial/blob/master/source/ja/013-ReverseQuantumAnnealing.ipynb"><img alt="Open in Colab" src="https://colab.research.google.com/assets/colab-badge.svg" /></a></p>
<section id="ポートフォリオ最適化問題">
<h2>ポートフォリオ最適化問題<a class="headerlink" href="#ポートフォリオ最適化問題" title="Permalink to this headline">¶</a></h2>
<p>資産運用して投資活動を行うとき、できるだけリスクを回避しながら大きな収益を実現させたい。なので、収益が限定的であるが、リスクが小さい（ないし全くない）資産と見込める収益が大きい分リスクも大きい資産を組み合わせてポートフォリオを作って分散投資を行うのが一般的な戦略になる。</p>
<p>この時、与えられた一定のリスクでは最大利益を実現したい、または同じ利益を実現する場合できるだけ小さいリスクを取るには、最適なポートフォリオを選ぶ必要がある。現在、よく利用される手法はMarkowitzによる現代ポートフォリオ理論(Modern Portfolio Theory)であり、ポートフォリオを構成する銘柄の間の相関を考慮して、その共分散を最小にさせるような手法になる[1]。</p>
<div class="math notranslate nohighlight">
\[\min \sum_{i=1}^{N}\sum_{j=1}^{N}w_{i}w_{j}\sigma_{ij}; \quad \sum_{i=1}^{N}W_{i}=1; \quad \sum_{i=1}^{N}W_{i}\mu_{i}=R\]</div>
<p>ただし、<span class="math notranslate nohighlight">\(w_{i}\)</span>は各銘柄がポートフォリオ内を占める重みで、<span class="math notranslate nohighlight">\(\sigma_{ij}\)</span>は銘柄間の共分散である。<span class="math notranslate nohighlight">\(\mu_{i}\)</span>は各銘柄の期待収益で、<span class="math notranslate nohighlight">\(R\)</span>はこのポートフォリオの総収益になる。</p>
<p>この時、ポートフォリオのパフォーマンスの評価によく使われる指標としてSharpe Ratioというのがある。</p>
<p>### Sharpe Ratio Sharpe Ratioは投資の効率性を評価する指標で、銘柄単体とポートフォリオにたいして計算できる。1966念にウィリアム・シャープによって提案された[3]。その基本的な定義は次のような形になる。</p>
<div class="math notranslate nohighlight">
\[S = \frac{\bar{r}-r_0}{\sigma}\]</div>
<p>ここの<span class="math notranslate nohighlight">\(\bar{r}\)</span>は一定時間内の平均的なリターン率であり、月間や年間リターンを利用することも多い。<span class="math notranslate nohighlight">\(r_0\)</span>はリスクなしの場合のリターン率で、安定した国債の利子率などを用いることが多い。そして<span class="math notranslate nohighlight">\(\sigma\)</span>はボラティリティを表していて、資産価値の変動の激しさを意味している。</p>
<p>また、これらの値は実際使う場面によって異なる計算方法で算出される。例えばリターンは単純リターンとして<span class="math notranslate nohighlight">\(r=P(t+1)/P(t) - 1\)</span>で価格<span class="math notranslate nohighlight">\(P\)</span>で計算される場合と<span class="math notranslate nohighlight">\(r=log[P(t+1)/P(t)]\)</span>のように対数リターン率として計算される場合がある。そしてボラティリティも価格の変動からとリターンからのやり方が存在する。具体的に興味がある方は金融工学や市場分析などに関連する本とサイトに参照してください。</p>
<p>### ポートフォリオの評価と最適化 Sharpe Ratioの定義から、その値が大きいということは収益が大きいまたはリスク（ボラティリティ）が小さいことを意味しているのが分かる。ある与えられた銘柄の集合で作られたポートフォリオのうち、最大のSharpe Ratioを実現できるような組み合わせは、同じリスクに対して最大のリターンを得る組み合わせになる。なので、ポートフォリオの最適化問題は一定の考え方の元でShape Ratioを最大にする問題に置き換えられる。</p>
<p>現実において、この最適化は銘柄を選別した上でそれぞれの銘柄に投入する資金の量を決定しなければならない。つまり、選ぶ銘柄と各銘柄のウェイトを決定する問題になる。このチュートリアルは、参考した論文[2]に従い、簡単のために各銘柄のウェイトが等しくする戦略について考える。この時、問題は<span class="math notranslate nohighlight">\(M\)</span>個ある銘柄のうち<span class="math notranslate nohighlight">\(N\)</span>個銘柄を選び出して、実現Sharpe Ratioを最大にするものになる。すると、次のようなQUBO形式に問題を翻訳できる。</p>
<div class="math notranslate nohighlight">
\[\mathcal{O}(\bm{q})=\sum_{i=1}^{N}a_{i}q_{i}+\sum_{i=1}^{N}\sum_{j=i+1}^{N}b_{ij}q_{i}q_{j}\]</div>
<p>ここの<span class="math notranslate nohighlight">\(q_{i}\)</span>は各銘柄に対する洗濯で<span class="math notranslate nohighlight">\(1\)</span>であればポートフォリオに組み入れて、<span class="math notranslate nohighlight">\(0\)</span>であれば組み入れない意味を持つ。そして<span class="math notranslate nohighlight">\(a_i\)</span>は銘柄自体のパフォーマンスによる魅力スコアであり、<span class="math notranslate nohighlight">\(b_ij\)</span>は銘柄間のペアワイズ相関で決められた罰金または賞金度合を表す。</p>
<p>具体的に<span class="math notranslate nohighlight">\(a_i\)</span>と<span class="math notranslate nohighlight">\(b_ij\)</span>は次の表1に従って決定される。</p>
<div><p><img alt="dbec0b122bfc4c7da0f35d369b4663e9" src="../_images/013_RQA_QUBO.png" /></p>
</div><p>ここの<span class="math notranslate nohighlight">\(a_i\)</span>のグループはポートフォリオを構成する人の基準によって決められた基準によって、銘柄を魅力的であるから魅力ではない順で並べてそれを順位付けした後に、均等に分けた場合形成されたグループになる。この魅力的な基準はリターン率の高さや損失の少なさなどの要素も取り入れられるが、このチュートリアルでは単純に銘柄単体のSharpe Ratio順を用いた。そして<span class="math notranslate nohighlight">\(b_{ij}\)</span>は対数リターンの時系列から求められた相関行列の成分<span class="math notranslate nohighlight">\(\rho_{ij}\)</span>の値によって決められている。</p>
<p>このQUBOを使って量子アニーリングを行えば最適のポートフォリオを得ることができるはず。また、選択銘柄の数について指定したい場合はこのチュートリアルシリーズで既に説明があったように銘柄数に対して罰金法の制限を付け加えればできる。ただし、参考にした論文[2]によると、罰金法を利用した場合、導入した大きい相互作用（ペナルティ）はアニーリングの性能や最終的に取得した結果にも影響するのが分かる。さらに、最適のポートフォリオに含まれる銘柄の数が分からないのがより現実的にであるので、このチュートリアルでは銘柄数制限なして最適化を行う。</p>
</section>
<section id="Reverse-Quantum-Annealingによるポートフォリオ最適化">
<h2>Reverse Quantum Annealingによるポートフォリオ最適化<a class="headerlink" href="#Reverse-Quantum-Annealingによるポートフォリオ最適化" title="Permalink to this headline">¶</a></h2>
<p>現実のポートフォリオ最適化の問題は基本、大きな市場から銘柄を選択することになる。候補銘柄数の増加によって最適のポートフォリオを作るための計算量が非常に大きくなる。なので、一定の条件の下に選別を行ってから最適化アルゴリズを適応するのが普通である。そして、銘柄の組合せの自由度から、最終的の実現Sharpe Ratioが最大Sharpe
Ratioと極めて近い値を持つ非最適解が多く存在することもあり得る。伝統的なアルゴリズムがそのような解にハマった場合抜け出すにも時間とリソースが必要となる。そのため、以上の既存な問題点を回避しながらポートフォリオ最適化問題を解くには、量子アニーリングのような大きい数の相関を取り扱えてローカルミニマムから脱却できる技術が有利である。</p>
<p>ただし、参考論文[2]に示されたように、単純なForward Annealingのみを行う場合、銘柄数の増加によって、最適解までにたどり着く時間も大きく増加して、伝統的の遺伝アルゴリズムと違いパフォーマンスになるのが分かる。その理由としてはやはり最適解と近い値のSharpe
Ratioを持つ解と最適解はエネルギーの違いも同じように小さいと考えられる。すると、最適解への変化はほとんどエネルギー差がほぼない準位の間で高いポテンシャルの障壁がある場合の遷移になるため、遷移が起こるまでにより長い時間が必要となる。また、量子アニーリングマシンの実機では通常のアニーリングを行う途中で熱ノイズなどによる影響で系が励起されて時間発展する場合もあって、それによって最終の結果が最適解とならない可能性もある。</p>
<section id="Reverse-Quantum-Annealing">
<h3>Reverse Quantum Annealing<a class="headerlink" href="#Reverse-Quantum-Annealing" title="Permalink to this headline">¶</a></h3>
<p>これらの量子アニーリングを用いた時の問題点を解決するために提案された手法の一つは、Reverse Quantum Annealingである。名前通り、通常のForward Annealingと逆方向のステップを導入するような量子アニーリングを指す。通常のForwardAnnealingの時間依存のハミルトニアンは次のように書ける。</p>
<div class="math notranslate nohighlight">
\[\mathcal{H}_{\mathrm{QA}}(t)=A[t]\sum_{i=1}^N\sigma_{i}^{\mathrm{x}}+B[t]\mathcal{H}_{\chi-\mathrm{Ising}}\]</div>
<p>この<span class="math notranslate nohighlight">\(A[t]\)</span>はアニーリングを行うとき系にかける横磁場を表していて、<span class="math notranslate nohighlight">\(B[t]\)</span>は問題のハミルトニアン<span class="math notranslate nohighlight">\(\mathcal{H}_{\chi-\mathrm{Ising}}\)</span>の振幅になる。次の図でのa)で示されるように、Forward Annealingの場合はアニーリングの侵攻によって、<span class="math notranslate nohighlight">\(A[t]\)</span>がだんだん小さくなり、同時に<span class="math notranslate nohighlight">\(B[t]\)</span>主導的になっていく。最終的にアニーリングが完了するときは<span class="math notranslate nohighlight">\(A[t]=0\)</span>になる。</p>
<div><p><img alt="8e4fc1aa866f401ab51488263bd8e2f4" src="../_images/013_QAandRQA.png" /></p>
</div><p>対してReverse Annealingはb)のように<span class="math notranslate nohighlight">\(A[t]=0,B[t]=1\)</span>の状態から出発して、まず通常と逆に<span class="math notranslate nohighlight">\(B[t]\)</span>を小さくしていく。これはReverse Phaseになる。この段階では系のエネルギーが逆に高くなるため、c)に示されたようなAとBの間のポテンシャル障壁は超えやすくなる。そしてある値に達するとそのまま系を維持してしばらく待つ。これはPause
Phaseになる。この時もまた高いエネルギーの状態にあり、熱的ホッピングが起こりやすいため、Bの右のようなポテンシャルの山も超えやすくなる。結果的に最初に入ったローカルミニマムから脱して最適解付近にたどり着く可能性が上がる。最後にまた<span class="math notranslate nohighlight">\(A[t]\)</span>を小さくして、<span class="math notranslate nohighlight">\(B[t]\)</span>を大きくさせるForward Phaseで通常のアニーリングをして、最適解を取得する。この時、Reverse Annealingを止めた場所や、各段階に使った時間などによって、最後のパフォーマンスにも影響するのが考えられる。</p>
</section>
<section id="Reverse-Quantum-Annealingによるポートフォリオ最適化の手順">
<h3>Reverse Quantum Annealingによるポートフォリオ最適化の手順<a class="headerlink" href="#Reverse-Quantum-Annealingによるポートフォリオ最適化の手順" title="Permalink to this headline">¶</a></h3>
<p>このReverse Quantum Annealingの手法を実行するには実際もう一つの条件がある。それがReverse Phaseの初期状態である。この状態はランダムに生成された初期状態を用いても可能ではあるが、手法が提案された背景からも、最適解探索の効率の観点からもある種類のローカルミニマム状態を用意したほうが良いと分かる。その初期状態になるローカルミニマムを得るには参考論文[2]では伝統的なアルゴリズムで得られた出力を利用した。このチュートリアルもそれに従う。</p>
<p>なので、これから行う実装は基本論文[2]の流れを参考にして以下のようになる。 - 最適化を行う銘柄データの生成 - 古典なアルゴリズムの実装とその結果の確認 - 通常のForward Annealingによる最適解探索 - Reverse Quantum Annealingによる最適解探索 - Reverse Quantum Annealingのパラメータ探索</p>
</section>
</section>
<section id="銘柄データの生成と古典アルゴリズムの実装">
<h2>銘柄データの生成と古典アルゴリズムの実装<a class="headerlink" href="#銘柄データの生成と古典アルゴリズムの実装" title="Permalink to this headline">¶</a></h2>
<section id="最適化を行う銘柄データの生成">
<h3>最適化を行う銘柄データの生成<a class="headerlink" href="#最適化を行う銘柄データの生成" title="Permalink to this headline">¶</a></h3>
<p>参考論文[2]にある方法に従って、与えられた初期値を用いて、ブラウン運動による銘柄チャートを生成する。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[213]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="c1">#Magic numbers to generate assets</span>
<span class="n">rho</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c1"># input uniform correlation</span>
<span class="n">mu</span> <span class="o">=</span> <span class="mf">0.075</span> <span class="c1"># expected value</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.15</span> <span class="c1"># volatility/standard error</span>
<span class="n">r0</span> <span class="o">=</span> <span class="mf">0.015</span> <span class="c1"># no risk return</span>
</pre></div>
</div>
</div>
<p>参考論文[2]の付録Aによって、各時刻においてチャートの運動は前の時刻の運動によって</p>
<div class="math notranslate nohighlight">
\[S(t_{n+1})=S(t_n)\exp(\mu-\frac{1}{2}\sigma^2)\Delta t + \sigma Z_n\sqrt{\Delta t}\]</div>
<p>のように与えられる。ここの<span class="math notranslate nohighlight">\(Z_n\)</span>はcholesky分解で作られた一様相関行列<span class="math notranslate nohighlight">\(\rho\)</span>を従う多変量正規分布になる。</p>
<p>それを実行して適当にチャートをプロットして様子を確認する。最初同じところから始めても一年間経つと、全体が広がっていく様子が分かる。また一部銘柄が大きく上昇または降下するのも確認できる。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[214]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#相関正規確率変数Znの生成</span>
<span class="k">def</span> <span class="nf">createZvariables</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">rho</span><span class="p">):</span>
  <span class="n">rho_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="n">N</span><span class="p">),</span> <span class="n">rho</span><span class="p">)</span>
  <span class="n">rho_mat</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1.0</span>
  <span class="n">rho_chole</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">rho_mat</span><span class="p">)</span>
  <span class="n">zNs_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
  <span class="n">zNs</span> <span class="o">=</span> <span class="n">zNs_temp</span> <span class="o">@</span> <span class="n">rho_chole</span>
  <span class="k">return</span> <span class="n">zNs</span>

<span class="c1">#チャートのブラウン運動の生成</span>
<span class="k">def</span> <span class="nf">GetNextSt</span><span class="p">(</span><span class="n">St</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">zN</span><span class="p">):</span>
  <span class="n">Deltat</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">mu</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">sigma</span><span class="o">*</span><span class="n">sigma</span><span class="p">)</span><span class="o">*</span><span class="n">Deltat</span> <span class="o">+</span> <span class="n">sigma</span><span class="o">*</span><span class="n">zN</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Deltat</span><span class="p">))</span>
  <span class="n">NextSt</span> <span class="o">=</span> <span class="n">St</span> <span class="o">*</span> <span class="n">scale</span>
  <span class="k">return</span> <span class="n">NextSt</span>

<span class="n">Nassets</span> <span class="o">=</span> <span class="mi">48</span> <span class="c1">#生成する銘柄の数</span>
<span class="n">chart</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="n">ZList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="n">Zvariables</span> <span class="o">=</span> <span class="n">createZvariables</span><span class="p">(</span><span class="n">Nassets</span><span class="p">,</span> <span class="n">rho</span><span class="p">)</span>
<span class="n">Zlabels</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">)],</span> <span class="mi">12</span><span class="p">)</span> <span class="c1">#Z variable shuffle</span>

<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">Zlabels</span><span class="p">:</span>
  <span class="n">ZList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Zvariables</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>

<span class="k">for</span> <span class="n">iasset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nassets</span><span class="p">):</span>
  <span class="n">chart_asset</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span> <span class="c1">#初値 相対価格で1.0</span>

  <span class="c1">#12ステップ（か月）シミュレーションを行う</span>
  <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
    <span class="n">chart_asset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GetNextSt</span><span class="p">(</span><span class="n">chart_asset</span><span class="p">[</span><span class="n">month</span><span class="p">],</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">ZList</span><span class="p">[</span><span class="n">month</span><span class="p">][</span><span class="n">iasset</span><span class="p">]))</span>

  <span class="n">chart</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chart_asset</span><span class="p">)</span>
  <span class="c1">#print(chart_asset) #各銘柄の具体的な数値をプリント</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">)),</span> <span class="n">chart_asset</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_13_0.png" src="../_images/ja_013-ReverseQuantumAnnealing_13_0.png" />
</div>
</div>
<p>銘柄のデータを生成できたので、各銘柄のSharpe Ratioを計算する。ここの結果を評価するに使うのは実現Sharpe Ratioで、その定義に従って無リスク利回り率を超過した超過収益率の平均<span class="math notranslate nohighlight">\(\bar{r}\)</span>と超過リターン率の標準偏差<span class="math notranslate nohighlight">\(\sigma\)</span>で求める。チャートを確認するとき分かったように、銘柄数が少ない場合は偶然による偏りが大きい、かつ生成条件に銘柄間に相関があるので、。銘柄を100回生成してその平均Shape Ratioの確認することでそれらの影響を減らす。結果として、銘柄の平均Sharpe
Ratioが期待通り<span class="math notranslate nohighlight">\(0.4\)</span>になるのを確認できる。また、Sharpe Ratioの計算定義を変更した場合、Sharpeの値が変化するのも確認できるが、おおむね<span class="math notranslate nohighlight">\(0.40\pm0.05\)</span>の範囲内には収まる。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[215]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="c1">#銘柄生成関数</span>
<span class="k">def</span> <span class="nf">CreateAssets</span><span class="p">(</span><span class="n">Nassets</span><span class="p">):</span>
  <span class="n">chart</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
  <span class="n">ZList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
  <span class="n">Zvariables</span> <span class="o">=</span> <span class="n">createZvariables</span><span class="p">(</span><span class="n">Nassets</span><span class="p">,</span> <span class="n">rho</span><span class="p">)</span>
  <span class="n">Zlabels</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">)],</span> <span class="mi">12</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">Zlabels</span><span class="p">:</span>
    <span class="n">ZList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Zvariables</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>
  <span class="k">for</span> <span class="n">iasset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nassets</span><span class="p">):</span>
    <span class="n">chart_asset</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
      <span class="n">chart_asset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GetNextSt</span><span class="p">(</span><span class="n">chart_asset</span><span class="p">[</span><span class="n">month</span><span class="p">],</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">ZList</span><span class="p">[</span><span class="n">month</span><span class="p">][</span><span class="n">iasset</span><span class="p">]))</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chart_asset</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">chart</span>

<span class="c1">#オーソドックスなSharpe Ratio</span>
<span class="k">def</span> <span class="nf">CalculateSharpeRatio</span><span class="p">(</span><span class="n">asset</span><span class="p">):</span>
    <span class="n">monthly_return</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
      <span class="n">valueChange</span> <span class="o">=</span> <span class="n">asset</span><span class="p">[</span><span class="n">month</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">asset</span><span class="p">[</span><span class="n">month</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">r0</span>
      <span class="n">monthly_return</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">valueChange</span><span class="p">)</span>

    <span class="n">annualized_excess_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">monthly_return</span><span class="p">)</span>
    <span class="n">volatility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">monthly_return</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">annualized_excess_return</span><span class="o">/</span><span class="n">volatility</span><span class="p">)</span>

<span class="c1">#log-returnに基づいたSharpe Ratio</span>
<span class="k">def</span> <span class="nf">CalculateSharpeRatio_log</span><span class="p">(</span><span class="n">asset</span><span class="p">):</span>
  <span class="n">monthly_log_return</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
    <span class="n">valueChange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">asset</span><span class="p">[</span><span class="n">month</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">asset</span><span class="p">[</span><span class="n">month</span><span class="p">])</span>
    <span class="n">monthly_log_return</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">valueChange</span><span class="p">)</span>
  <span class="n">mean_log_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">monthly_log_return</span><span class="p">)</span>
  <span class="n">volatility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">monthly_log_return</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">mean_log_return</span><span class="o">-</span><span class="n">r0</span><span class="p">)</span><span class="o">/</span><span class="n">volatility</span>

<span class="c1">#少し変わった定義のSharpe Ratio</span>
<span class="k">def</span> <span class="nf">CalculateSharpeRatio_2</span><span class="p">(</span><span class="n">asset</span><span class="p">):</span>
  <span class="n">monthly_log_return</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
  <span class="n">monthly_return</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">):</span>
    <span class="n">log_valueChange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">asset</span><span class="p">[</span><span class="n">month</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">asset</span><span class="p">[</span><span class="n">month</span><span class="p">])</span>
    <span class="n">monthly_log_return</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_valueChange</span><span class="p">)</span>
    <span class="n">valueChange</span> <span class="o">=</span> <span class="n">asset</span><span class="p">[</span><span class="n">month</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">asset</span><span class="p">[</span><span class="n">month</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span>
    <span class="n">monthly_return</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">valueChange</span><span class="p">)</span>
  <span class="n">annualized_excess_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">monthly_return</span><span class="p">)</span> <span class="o">-</span> <span class="n">r0</span>
  <span class="n">volatility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">monthly_log_return</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">annualized_excess_return</span><span class="o">/</span><span class="n">volatility</span><span class="p">)</span>

<span class="n">allmean</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">ntry</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span> <span class="c1">#複数回試行で同じセットないの相関による影響を消す</span>
  <span class="n">Chart</span> <span class="o">=</span> <span class="n">CreateAssets</span><span class="p">(</span><span class="mi">48</span><span class="p">)</span> <span class="c1">#指定した数の銘柄を作る</span>
  <span class="n">mean_SR</span> <span class="o">=</span> <span class="mf">0.0</span>
  <span class="n">n</span> <span class="o">=</span> <span class="mf">0.</span>
  <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">Chart</span><span class="p">:</span>
    <span class="n">assetSR</span> <span class="o">=</span> <span class="n">CalculateSharpeRatio</span><span class="p">(</span><span class="n">asset</span><span class="p">)</span> <span class="c1">#ここを変更すればShape Ratioの計算方法を変えられる</span>
    <span class="c1">#assetSR = CalculateSharpeRatio_log(asset)</span>
    <span class="c1">#assetSR = CalculateSharpeRatio_2(asset)</span>
    <span class="n">mean_SR</span> <span class="o">=</span> <span class="p">((</span><span class="n">mean_SR</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="o">+</span><span class="n">assetSR</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#平均Shape Ratio</span>
    <span class="n">n</span><span class="o">+=</span><span class="mi">1</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SubSet &quot;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ntry</span><span class="p">)</span><span class="o">+</span> <span class="s2">&quot; average Sharpe Ratio: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mean_SR</span><span class="p">))</span>
  <span class="n">allmean</span> <span class="o">=</span> <span class="p">((</span><span class="n">allmean</span><span class="o">*</span><span class="n">ntry</span><span class="p">)</span><span class="o">+</span><span class="n">mean_SR</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ntry</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Average Sharpe Ratio of all generated: &quot;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">allmean</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
SubSet 0 average Sharpe Ratio: 0.3600512964634801
Average Sharpe Ratio of all generated: 0.3600512964634801
SubSet 1 average Sharpe Ratio: 0.25021007319060234
Average Sharpe Ratio of all generated: 0.3051306848270412
SubSet 2 average Sharpe Ratio: 0.4269319254372476
Average Sharpe Ratio of all generated: 0.3457310983637767
SubSet 3 average Sharpe Ratio: 0.3189863589398198
Average Sharpe Ratio of all generated: 0.3390449135077875
SubSet 4 average Sharpe Ratio: 0.2764421536249738
Average Sharpe Ratio of all generated: 0.3265243615312247
SubSet 5 average Sharpe Ratio: 0.38203104550409916
Average Sharpe Ratio of all generated: 0.3357754755267038
SubSet 6 average Sharpe Ratio: 0.37368187024134825
Average Sharpe Ratio of all generated: 0.341190674771653
SubSet 7 average Sharpe Ratio: 0.36857405871944154
Average Sharpe Ratio of all generated: 0.34461359776512657
SubSet 8 average Sharpe Ratio: 0.5584916564996508
Average Sharpe Ratio of all generated: 0.368377826513407
SubSet 9 average Sharpe Ratio: 0.3170391359924436
Average Sharpe Ratio of all generated: 0.3632439574613106
SubSet 10 average Sharpe Ratio: 0.3269090003337926
Average Sharpe Ratio of all generated: 0.35994077954062714
SubSet 11 average Sharpe Ratio: 0.45332771039580405
Average Sharpe Ratio of all generated: 0.36772302377855853
SubSet 12 average Sharpe Ratio: 0.5519568363147792
Average Sharpe Ratio of all generated: 0.38189485551211394
SubSet 13 average Sharpe Ratio: 0.2976800861934678
Average Sharpe Ratio of all generated: 0.3758795148464964
SubSet 14 average Sharpe Ratio: 0.3453009678312409
Average Sharpe Ratio of all generated: 0.3738409450454794
SubSet 15 average Sharpe Ratio: 0.4271483125464575
Average Sharpe Ratio of all generated: 0.3771726555142905
SubSet 16 average Sharpe Ratio: 0.2785943080380704
Average Sharpe Ratio of all generated: 0.37137392919215995
SubSet 17 average Sharpe Ratio: 0.4465147892570203
Average Sharpe Ratio of all generated: 0.3755484214179855
SubSet 18 average Sharpe Ratio: 0.40639020455488845
Average Sharpe Ratio of all generated: 0.37717167316203304
SubSet 19 average Sharpe Ratio: 0.510145216738688
Average Sharpe Ratio of all generated: 0.3838203503408658
SubSet 20 average Sharpe Ratio: 0.40881803913787595
Average Sharpe Ratio of all generated: 0.3850107164740567
SubSet 21 average Sharpe Ratio: 0.48162608240031807
Average Sharpe Ratio of all generated: 0.3894023240161595
SubSet 22 average Sharpe Ratio: 0.4809116057673431
Average Sharpe Ratio of all generated: 0.393380988440124
SubSet 23 average Sharpe Ratio: 0.3790710781225293
Average Sharpe Ratio of all generated: 0.39278474217689086
SubSet 24 average Sharpe Ratio: 0.4431766158075707
Average Sharpe Ratio of all generated: 0.39480041712211805
SubSet 25 average Sharpe Ratio: 0.439951870033362
Average Sharpe Ratio of all generated: 0.3965370114648582
SubSet 26 average Sharpe Ratio: 0.465975883759055
Average Sharpe Ratio of all generated: 0.39910882154982846
SubSet 27 average Sharpe Ratio: 0.4464054677214715
Average Sharpe Ratio of all generated: 0.40079798748453
SubSet 28 average Sharpe Ratio: 0.349073108477391
Average Sharpe Ratio of all generated: 0.39901437096704245
SubSet 29 average Sharpe Ratio: 0.35673879440451045
Average Sharpe Ratio of all generated: 0.39760518508162473
SubSet 30 average Sharpe Ratio: 0.3994224916535239
Average Sharpe Ratio of all generated: 0.39766380787426664
SubSet 31 average Sharpe Ratio: 0.4030313748562615
Average Sharpe Ratio of all generated: 0.397831544342454
SubSet 32 average Sharpe Ratio: 0.48856086283813466
Average Sharpe Ratio of all generated: 0.40058091763020187
SubSet 33 average Sharpe Ratio: 0.3499685399096956
Average Sharpe Ratio of all generated: 0.39909231828548114
SubSet 34 average Sharpe Ratio: 0.11360995678877545
Average Sharpe Ratio of all generated: 0.3909356793855752
SubSet 35 average Sharpe Ratio: 0.3481410808978804
Average Sharpe Ratio of all generated: 0.38974694053869485
SubSet 36 average Sharpe Ratio: 0.4984334113846817
Average Sharpe Ratio of all generated: 0.3926844127237215
SubSet 37 average Sharpe Ratio: 0.47657606896796567
Average Sharpe Ratio of all generated: 0.3948920878880437
SubSet 38 average Sharpe Ratio: 0.2527810163191188
Average Sharpe Ratio of all generated: 0.39124821425807127
SubSet 39 average Sharpe Ratio: 0.37513878709458154
Average Sharpe Ratio of all generated: 0.390845478578984
SubSet 40 average Sharpe Ratio: 0.40825137518508153
Average Sharpe Ratio of all generated: 0.39127001264254735
SubSet 41 average Sharpe Ratio: 0.422850995048417
Average Sharpe Ratio of all generated: 0.3920219407950681
SubSet 42 average Sharpe Ratio: 0.37402933639199176
Average Sharpe Ratio of all generated: 0.39160350813453143
SubSet 43 average Sharpe Ratio: 0.3102965682809806
Average Sharpe Ratio of all generated: 0.38975562313785983
SubSet 44 average Sharpe Ratio: 0.5027244521159293
Average Sharpe Ratio of all generated: 0.3922660415595947
SubSet 45 average Sharpe Ratio: 0.3408073804642602
Average Sharpe Ratio of all generated: 0.3911473750140439
SubSet 46 average Sharpe Ratio: 0.3004322301012465
Average Sharpe Ratio of all generated: 0.3892172655478142
SubSet 47 average Sharpe Ratio: 0.46694332805110045
Average Sharpe Ratio of all generated: 0.3908365585166327
SubSet 48 average Sharpe Ratio: 0.3188902460653895
Average Sharpe Ratio of all generated: 0.389368266425791
SubSet 49 average Sharpe Ratio: 0.24715643147011115
Average Sharpe Ratio of all generated: 0.3865240297266774
SubSet 50 average Sharpe Ratio: 0.43562370060766936
Average Sharpe Ratio of all generated: 0.3874867683714027
SubSet 51 average Sharpe Ratio: 0.5385826211351911
Average Sharpe Ratio of all generated: 0.39039245784762944
SubSet 52 average Sharpe Ratio: 0.41785011536819744
Average Sharpe Ratio of all generated: 0.3909105268574515
SubSet 53 average Sharpe Ratio: 0.4909480101826902
Average Sharpe Ratio of all generated: 0.3927630728449559
SubSet 54 average Sharpe Ratio: 0.5446723722899334
Average Sharpe Ratio of all generated: 0.39552506010759186
SubSet 55 average Sharpe Ratio: 0.21065980604379353
Average Sharpe Ratio of all generated: 0.3922238948564526
SubSet 56 average Sharpe Ratio: 0.4207171541315678
Average Sharpe Ratio of all generated: 0.3927237765981213
SubSet 57 average Sharpe Ratio: 0.42509520889263314
Average Sharpe Ratio of all generated: 0.3932819047411301
SubSet 58 average Sharpe Ratio: 0.3880996172763241
Average Sharpe Ratio of all generated: 0.3931940693603707
SubSet 59 average Sharpe Ratio: 0.4256812245840667
Average Sharpe Ratio of all generated: 0.39373552194743233
SubSet 60 average Sharpe Ratio: 0.33029281367413044
Average Sharpe Ratio of all generated: 0.39269547754950934
SubSet 61 average Sharpe Ratio: 0.4544183273756479
Average Sharpe Ratio of all generated: 0.39369100738541485
SubSet 62 average Sharpe Ratio: 0.46097702151638215
Average Sharpe Ratio of all generated: 0.39475903935574763
SubSet 63 average Sharpe Ratio: 0.5197013980471027
Average Sharpe Ratio of all generated: 0.3967112637103001
SubSet 64 average Sharpe Ratio: 0.5263515026900675
Average Sharpe Ratio of all generated: 0.3987057289253734
SubSet 65 average Sharpe Ratio: 0.4552840487109043
Average Sharpe Ratio of all generated: 0.3995629761948512
SubSet 66 average Sharpe Ratio: 0.5928545996311347
Average Sharpe Ratio of all generated: 0.4024479257983778
SubSet 67 average Sharpe Ratio: 0.41211408620813045
Average Sharpe Ratio of all generated: 0.4025900752161683
SubSet 68 average Sharpe Ratio: 0.460167463327895
Average Sharpe Ratio of all generated: 0.4034245301163383
SubSet 69 average Sharpe Ratio: 0.26637418930739165
Average Sharpe Ratio of all generated: 0.4014666681047819
SubSet 70 average Sharpe Ratio: 0.22858538576155504
Average Sharpe Ratio of all generated: 0.3990317204661449
SubSet 71 average Sharpe Ratio: 0.3618889424380825
Average Sharpe Ratio of all generated: 0.39851584854908845
SubSet 72 average Sharpe Ratio: 0.40772580114698226
Average Sharpe Ratio of all generated: 0.39864201228330615
SubSet 73 average Sharpe Ratio: 0.36816522151159775
Average Sharpe Ratio of all generated: 0.39823016375936415
SubSet 74 average Sharpe Ratio: 0.47041751782737723
Average Sharpe Ratio of all generated: 0.39919266181360435
SubSet 75 average Sharpe Ratio: 0.4229345680986171
Average Sharpe Ratio of all generated: 0.39950505531735453
SubSet 76 average Sharpe Ratio: 0.4065096428420472
Average Sharpe Ratio of all generated: 0.39959602398650634
SubSet 77 average Sharpe Ratio: 0.36602561350027113
Average Sharpe Ratio of all generated: 0.39916563410847766
SubSet 78 average Sharpe Ratio: 0.4824113461177466
Average Sharpe Ratio of all generated: 0.4002193772984684
SubSet 79 average Sharpe Ratio: 0.3533144186326638
Average Sharpe Ratio of all generated: 0.39963306531514586
SubSet 80 average Sharpe Ratio: 0.43284327512881643
Average Sharpe Ratio of all generated: 0.4000430679054381
SubSet 81 average Sharpe Ratio: 0.5138758916145698
Average Sharpe Ratio of all generated: 0.4014312730726226
SubSet 82 average Sharpe Ratio: 0.5313842386967979
Average Sharpe Ratio of all generated: 0.4029969714536367
SubSet 83 average Sharpe Ratio: 0.3991101374114235
Average Sharpe Ratio of all generated: 0.4029506996198009
SubSet 84 average Sharpe Ratio: 0.44262684583284945
Average Sharpe Ratio of all generated: 0.40341747781054266
SubSet 85 average Sharpe Ratio: 0.4738021823655563
Average Sharpe Ratio of all generated: 0.40423590460769393
SubSet 86 average Sharpe Ratio: 0.4477454542431058
Average Sharpe Ratio of all generated: 0.40473601437361817
SubSet 87 average Sharpe Ratio: 0.36682942551042236
Average Sharpe Ratio of all generated: 0.404305257681991
SubSet 88 average Sharpe Ratio: 0.38825174638819254
Average Sharpe Ratio of all generated: 0.40412488115059997
SubSet 89 average Sharpe Ratio: 0.42603754345330774
Average Sharpe Ratio of all generated: 0.4043683551761856
SubSet 90 average Sharpe Ratio: 0.37272905948831686
Average Sharpe Ratio of all generated: 0.404020670608187
SubSet 91 average Sharpe Ratio: 0.2901110955527487
Average Sharpe Ratio of all generated: 0.40278252305323653
SubSet 92 average Sharpe Ratio: 0.4929100867710136
Average Sharpe Ratio of all generated: 0.40375163664159974
SubSet 93 average Sharpe Ratio: 0.4830173173819965
Average Sharpe Ratio of all generated: 0.40459488856436987
SubSet 94 average Sharpe Ratio: 0.4071516269656441
Average Sharpe Ratio of all generated: 0.40462180160017275
SubSet 95 average Sharpe Ratio: 0.6294880003750024
Average Sharpe Ratio of all generated: 0.4069641578374106
SubSet 96 average Sharpe Ratio: 0.4796841492715549
Average Sharpe Ratio of all generated: 0.40771384847075226
SubSet 97 average Sharpe Ratio: 0.44876206355054693
Average Sharpe Ratio of all generated: 0.4081327078083012
SubSet 98 average Sharpe Ratio: 0.4707963381403682
Average Sharpe Ratio of all generated: 0.40876567377125134
SubSet 99 average Sharpe Ratio: 0.37064232910513106
Average Sharpe Ratio of all generated: 0.40838444032459015
</pre></div></div>
</div>
<p>銘柄の確認ができてから、作られたポートフォリオ全体のパフォーマンスを確認する、ここでは全銘柄が同じ重みで選ばれるシナリオで銘柄全体のSharpe Ratioを計算しているが、48銘柄の場合で論文の結果「平均1.4、25パーセント分位0.5、75パーセント分位2.1」を再現できていない。（TODO）</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[216]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Nassets</span> <span class="o">=</span> <span class="mi">48</span>
<span class="n">SR_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

<span class="k">for</span> <span class="n">ntry</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">Chart</span> <span class="o">=</span> <span class="n">CreateAssets</span><span class="p">(</span><span class="n">Nassets</span><span class="p">)</span>
    <span class="n">portfolioChart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Chart</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">portfolioSR</span> <span class="o">=</span> <span class="n">CalculateSharpeRatio</span><span class="p">(</span><span class="n">portfolioChart</span><span class="p">)</span>
    <span class="n">SR_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">portfolioSR</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">portfolioSR</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">SR_list</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">SR_list</span><span class="p">,</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span><span class="mi">75</span><span class="p">]))</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.6424289431873234
0.6424289431873234 [0.64242894 0.64242894]
1.0690140063361937
0.8557214747617585 [0.74907521 0.96236774]
1.6944740511688996
1.1353056668974721 [0.85572147 1.38174403]
1.8803181393782316
1.321558785017662 [0.96236774 1.74093507]
2.1399546304938237
1.4852379541128944 [1.06901401 1.88031814]
0.955090006803346
1.3968799628946362 [0.98357101 1.83385712]
1.0640348880987391
1.3493306664952223 [1.00956245 1.7873961 ]
1.1884688150400942
1.3292229350633313 [1.03679867 1.74093507]
1.5068308301487452
1.3489571456283773 [1.06403489 1.69447405]
2.2064989892261875
1.4347113299881582 [1.06527967 1.83385712]
</pre></div></div>
</div>
</section>
<section id="古典アルゴリズムによる探索">
<h3>古典アルゴリズムによる探索<a class="headerlink" href="#古典アルゴリズムによる探索" title="Permalink to this headline">¶</a></h3>
<p>続いてはQUBO行列の準備及び古典なアルゴリズムに必要な関数を実装する。ここで、ペアワイズ相関行列は論文に従い対数リターンで計算した。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[217]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">heapq</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="c1">#Attractiveness Coversion</span>
<span class="k">def</span> <span class="nf">SRBucket</span><span class="p">(</span><span class="n">SR_list</span><span class="p">):</span>
    <span class="n">Buckets</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">SR_list</span><span class="p">)</span>
    <span class="n">Buckets</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="n">GroupedList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">Buckets</span><span class="p">,</span><span class="mi">11</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">SR_list</span><span class="p">)):</span>
        <span class="k">if</span>   <span class="n">SR_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">GroupedList</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">SR_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">15</span>
        <span class="k">elif</span> <span class="n">SR_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">GroupedList</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">SR_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">12</span>
        <span class="k">elif</span> <span class="n">SR_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">GroupedList</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">SR_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">9</span>
        <span class="k">elif</span> <span class="n">SR_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">GroupedList</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">SR_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">6</span>
        <span class="k">elif</span> <span class="n">SR_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">GroupedList</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">SR_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">3</span>
        <span class="k">elif</span> <span class="n">SR_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">GroupedList</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">SR_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">elif</span> <span class="n">SR_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">GroupedList</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="n">SR_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=-</span><span class="mi">3</span>
        <span class="k">elif</span> <span class="n">SR_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">GroupedList</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="n">SR_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=-</span><span class="mi">6</span>
        <span class="k">elif</span> <span class="n">SR_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">GroupedList</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="n">SR_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=-</span><span class="mi">9</span>
        <span class="k">elif</span> <span class="n">SR_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">GroupedList</span><span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="n">SR_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=-</span><span class="mi">12</span>
        <span class="k">elif</span> <span class="n">SR_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">GroupedList</span><span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="n">SR_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=-</span><span class="mi">15</span>

<span class="c1">#Penalty/Reward Conversion</span>
<span class="k">def</span> <span class="nf">CorrelationBucket</span><span class="p">(</span><span class="n">Corr</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Corr</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Corr</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">Corr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mf">1.00</span> <span class="ow">and</span>  <span class="n">Corr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">:</span> <span class="n">Corr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span>
            <span class="k">elif</span> <span class="n">Corr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mf">0.25</span> <span class="ow">and</span>  <span class="n">Corr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">:</span> <span class="n">Corr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span>
            <span class="k">elif</span> <span class="n">Corr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mf">0.15</span> <span class="ow">and</span>  <span class="n">Corr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">:</span> <span class="n">Corr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">elif</span> <span class="n">Corr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mf">0.05</span> <span class="ow">and</span>  <span class="n">Corr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span> <span class="n">Corr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">Corr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.05</span> <span class="ow">and</span>  <span class="n">Corr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.15</span><span class="p">:</span> <span class="n">Corr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">Corr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.15</span> <span class="ow">and</span>  <span class="n">Corr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.25</span><span class="p">:</span> <span class="n">Corr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="k">elif</span> <span class="n">Corr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.25</span> <span class="ow">and</span>  <span class="n">Corr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.00</span><span class="p">:</span> <span class="n">Corr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c1">#Ising component for classical algorithms</span>
<span class="k">def</span> <span class="nf">hi</span><span class="p">(</span><span class="n">SR_list</span><span class="p">,</span> <span class="n">Corr</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">SR_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Corr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">h</span>

<span class="k">def</span> <span class="nf">jij</span><span class="p">(</span><span class="n">Corr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">4.</span><span class="o">*</span><span class="n">Corr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>

<span class="c1">#Create Pairwise Correlation Matrix</span>
<span class="k">def</span> <span class="nf">CreateCorrMat</span><span class="p">(</span><span class="n">Chart</span><span class="p">):</span>
    <span class="n">assets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">iasset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Chart</span><span class="p">)):</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
            <span class="n">log_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Chart</span><span class="p">[</span><span class="n">iasset</span><span class="p">][</span><span class="n">month</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">Chart</span><span class="p">[</span><span class="n">iasset</span><span class="p">][</span><span class="n">month</span><span class="p">])</span>
            <span class="n">returns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_return</span><span class="p">)</span>
        <span class="n">assets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    <span class="n">Chart_pd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">assets</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">pairwise_corr</span> <span class="o">=</span> <span class="n">Chart_pd</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;pearson&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pairwise_corr</span>

<span class="c1">#Initial state for Greedy Search and Genetic Algorithm</span>
<span class="k">def</span> <span class="nf">GenerateRandomSolution</span><span class="p">(</span><span class="n">Nassets</span><span class="p">):</span>
    <span class="n">Solution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">Nassets</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nassets</span><span class="p">):</span>
        <span class="n">Solution</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">Solution</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">Solution</span>

<span class="c1">#得られた解のポートフォリオのSharpe Ratioを計算する</span>
<span class="k">def</span> <span class="nf">EvaluateSolution</span><span class="p">(</span><span class="n">Solution</span><span class="p">,</span><span class="n">Chart</span><span class="p">):</span>
    <span class="n">selected_assets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Solution</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">Solution</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">selected_assets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Chart</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">portfolioChart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">selected_assets</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">portfolioSR</span> <span class="o">=</span> <span class="n">CalculateSharpeRatio</span><span class="p">(</span><span class="n">portfolioChart</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">portfolioSR</span>

<span class="c1">#遺伝アルゴリズム、突然変異を導入して子孫を作る</span>
<span class="k">def</span> <span class="nf">CreateDescendant</span><span class="p">(</span><span class="n">Ancestor</span><span class="p">,</span> <span class="n">Ndescendants</span><span class="p">,</span> <span class="n">MaxMutation</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">index_list</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Ancestor</span><span class="p">))</span>
    <span class="n">Descendants</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">Ndescendants</span><span class="p">:</span>
        <span class="n">Nmutaion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">MaxMutation</span><span class="p">)</span>
        <span class="n">Place_to_change</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">index_list</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">Nmutaion</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">Descendant</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">Place_to_change</span><span class="p">:</span>
            <span class="n">Descendant</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">Ancestor</span><span class="p">)</span>
            <span class="n">Descendant</span><span class="p">[</span><span class="n">place</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ancestor</span><span class="p">[</span><span class="n">place</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">Descendants</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Descendant</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">Descendants</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[218]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#銘柄セットを再生成する</span>
<span class="c1">#ここからさっきのステップはこの銘柄セットをずっと使う</span>
<span class="n">Nassets</span> <span class="o">=</span> <span class="mi">48</span>

<span class="n">Chart</span> <span class="o">=</span> <span class="n">CreateAssets</span><span class="p">(</span><span class="n">Nassets</span><span class="p">)</span>
<span class="n">PairwiseCorrMat</span> <span class="o">=</span> <span class="n">CreateCorrMat</span><span class="p">(</span><span class="n">Chart</span><span class="p">)</span>
<span class="n">SR_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

<span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">Chart</span><span class="p">:</span>
    <span class="n">SR_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CalculateSharpeRatio</span><span class="p">(</span><span class="n">asset</span><span class="p">))</span>

<span class="c1">#Bucketの翻訳</span>
<span class="n">SRBucket</span><span class="p">(</span><span class="n">SR_list</span><span class="p">)</span>
<span class="n">CorrelationBucket</span><span class="p">(</span><span class="n">PairwiseCorrMat</span><span class="p">)</span>

<span class="c1">#print(PairwiseCorrMat)　#ペアワイズ相関行列の確認</span>
<br/></pre></div>
</div>
</div>
<section id="貪欲サーチ">
<h4>貪欲サーチ<a class="headerlink" href="#貪欲サーチ" title="Permalink to this headline">¶</a></h4>
<p>まずは貪欲サーチのアルゴリズムで探索を行う。ランダムに生成した初期状態から出発して、全体のパフォーマンスに対する影響を見ながら、ポートフォリオのSharpe Ratioを高くできそうな銘柄を選んでいくアルゴリズムである。イタレーションを行うことで、ランダムな初期状態からある一定の状態に落ち着くことを観測できる。</p>
<p>実行後、アルゴリズムの初期状態と得られた状態の比較を行う。このとき比較の基準がポートフォリオのSharpe Ratioになる。このチュートリアルでは全銘柄のウエイトが同じというシナリオなので、選ばれた銘柄の平均的なチャートを得てSharpe Ratioの計算を行った。</p>
<p>また、一個前のコードブロック複数回実行して銘柄セットをリセットすると、貪欲サーチの結果は初期状態よりも悪くなったり、ほぼ変わらなかったりする場合もあるのが分かる。そして最終的なリターンが初期状態に負けたが、Sharpe Ratioが大きい最終状態もある。それらを比較すると、Sharpe Ratioが大きい場合ポートフォリオのチャートが滑らかで、変動が小さくリスクが非常に小さいのが分かる。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[219]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Greedy Search</span>

<span class="c1">#初期状態生成</span>
<span class="n">Solution</span> <span class="o">=</span> <span class="n">GenerateRandomSolution</span><span class="p">(</span><span class="n">Nassets</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initial random selection:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Solution</span><span class="p">,</span> <span class="n">EvaluateSolution</span><span class="p">(</span><span class="n">Solution</span><span class="p">,</span> <span class="n">Chart</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

<span class="n">selected_charts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nassets</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">Solution</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">selected_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Chart</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">portfolioChart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">selected_charts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">#初期状態に基づいてエネルギーの初期化を行う</span>
<span class="n">Energies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">iasset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nassets</span><span class="p">):</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">hi</span><span class="p">(</span><span class="n">SR_list</span><span class="p">,</span> <span class="n">PairwiseCorrMat</span><span class="p">,</span> <span class="n">iasset</span><span class="p">)</span>
    <span class="n">energyTuple</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">h</span><span class="p">),</span> <span class="n">h</span> <span class="p">,</span> <span class="n">iasset</span><span class="p">]</span>
    <span class="n">Energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">energyTuple</span><span class="p">)</span>

<span class="c1">#貪欲サーチの実行</span>
<span class="n">NGreedyLoop</span> <span class="o">=</span> <span class="mi">10</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NGreedyLoop</span><span class="p">):</span>
    <span class="n">heapq</span><span class="o">.</span><span class="n">heapify</span><span class="p">(</span><span class="n">Energies</span><span class="p">)</span>

    <span class="n">ntry</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1">#print(Energies) #エネルギー変化を確認</span>
    <span class="k">while</span><span class="p">(</span><span class="n">ntry</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">Energies</span><span class="p">)):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="n">Energies</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">e</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Solution</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Solution</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">for</span> <span class="n">ie</span> <span class="ow">in</span> <span class="n">Energies</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">ie</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">ie</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ie</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">Solution</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">jij</span><span class="p">(</span><span class="n">PairwiseCorrMat</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">jij</span><span class="p">(</span><span class="n">PairwiseCorrMat</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
            <span class="n">ie</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">ie</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ntry</span><span class="o">+=</span><span class="mi">1</span>


<span class="c1">#貪欲サーチの出力</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Selection After Greedy Search:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Solution</span><span class="p">,</span> <span class="n">EvaluateSolution</span><span class="p">(</span><span class="n">Solution</span><span class="p">,</span> <span class="n">Chart</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

<span class="n">selected_charts2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nassets</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">Solution</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">selected_charts2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Chart</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">portfolioChart2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">selected_charts2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">)),</span> <span class="n">portfolioChart</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Before Greedy Search&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">)),</span> <span class="n">portfolioChart2</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;After Greedy Search&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Initial random selection:
[ 1 -1  1 -1  1  1 -1  1 -1  1  1 -1  1  1 -1  1 -1 -1  1  1 -1  1  1  1
  1  1 -1 -1 -1  1 -1 -1 -1  1  1 -1 -1 -1 -1  1 -1 -1  1  1  1  1  1  1] 1.7235493388179437

Selection After Greedy Search:
[-1 -1 -1  1 -1 -1 -1 -1 -1 -1 -1  1 -1 -1 -1 -1  1  1  1  1 -1 -1 -1  1
 -1 -1  1  1  1 -1  1  1 -1  1  1 -1 -1 -1 -1 -1 -1 -1  1 -1  1 -1 -1  1] 2.1161604239414697

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_22_1.png" src="../_images/ja_013-ReverseQuantumAnnealing_22_1.png" />
</div>
</div>
</section>
<section id="遺伝的アルゴリズム">
<h4>遺伝的アルゴリズム<a class="headerlink" href="#遺伝的アルゴリズム" title="Permalink to this headline">¶</a></h4>
<p>貪欲サーチのほかに使われた古典アルゴリズムは遺伝的アルゴリズムである。ランダムに生成した複数のポートフォリオからパフォーマンスが良いものを選択して、その良いポートフォリオをもとで次の世代のポートフォリオを生成する。次の世代のポートフォリオは前の世代のポートフォリオにランダムな変更を加える突然変異と、ポートフォリオ間の遺伝子を交換させるなどで生成できる。ここでは銘柄数が比較的に小さいため、突然変異のみを考えていて、遺伝子間の交換や交配を行わなかった。</p>
<p>結果を比較することで、ラスト世代が第一世代よりもパフォーマンスが良くなっていることを観測できる。ただし、ここで試行した世代数が限られているため、パフォーマンスが改善されないまたは改善が小さい場合もある。そして総じて貪欲サーチよりも安定な出力が得られるのも観察できる。</p>
<p>注意：遺伝子の組数や子孫数、そして変異の数を増やした場合計算量の増加により計算が終わらない場合もあるので、実行環境に合わせて設定を変えてください。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[220]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Genetic Algorithm</span>
<span class="n">Ngenes</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1">#遺伝子の組数</span>
<span class="n">NGenerations</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1">#世代数</span>
<span class="c1">#ランダム初期化</span>
<span class="n">Genes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ngenes</span><span class="p">):</span>
    <span class="n">gene</span> <span class="o">=</span> <span class="n">GenerateRandomSolution</span><span class="p">(</span><span class="n">Nassets</span><span class="p">)</span>
    <span class="n">geneSR</span> <span class="o">=</span> <span class="n">EvaluateSolution</span><span class="p">(</span><span class="n">gene</span><span class="p">,</span> <span class="n">Chart</span><span class="p">)</span>
    <span class="n">Genes</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">geneSR</span><span class="p">,</span> <span class="n">gene</span><span class="p">])</span>
<span class="n">Genes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">Genes</span><span class="p">,</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">#第一世代最優良ポートフォリオ</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best Gene 1st generation:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Genes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">EvaluateSolution</span><span class="p">(</span><span class="n">Genes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">Chart</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

<span class="n">selected_charts3</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nassets</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">Genes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">selected_charts3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Chart</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">portfolioChart3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">selected_charts3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


<span class="c1">#遺伝的アルゴリズム実行</span>
<span class="n">K_best</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1">#上位抽出遺伝子組数</span>
<span class="n">Ndescendants</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1">#子孫数</span>
<span class="n">MaxMutation</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1">#最大変異数</span>
<span class="k">for</span> <span class="n">iIter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NGenerations</span><span class="p">):</span>
    <span class="n">selected_Genes</span> <span class="o">=</span> <span class="n">Genes</span><span class="p">[:</span><span class="n">K_best</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">selected_Genes</span><span class="p">:</span>
        <span class="n">Descendants</span> <span class="o">=</span> <span class="n">CreateDescendant</span><span class="p">(</span><span class="n">gene</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Ndescendants</span><span class="p">,</span> <span class="n">MaxMutation</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">Descendant</span> <span class="ow">in</span> <span class="n">Descendants</span><span class="p">:</span>
            <span class="n">DescendantSR</span> <span class="o">=</span> <span class="n">EvaluateSolution</span><span class="p">(</span><span class="n">Descendant</span><span class="p">,</span> <span class="n">Chart</span><span class="p">)</span>
            <span class="n">selected_Genes</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">DescendantSR</span><span class="p">,</span> <span class="n">Descendant</span><span class="p">])</span>
    <span class="n">selected_Genes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">selected_Genes</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">selected_Genes</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">selected_Genes</span><span class="p">[:</span><span class="n">K_best</span><span class="p">])</span>

<span class="c1">#ラスト世代最優良ポートフォリオ</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best Gene last generation:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">selected_Genes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">EvaluateSolution</span><span class="p">(</span><span class="n">selected_Genes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">Chart</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">selected_charts4</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nassets</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">selected_Genes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">selected_charts4</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Chart</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">portfolioChart4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">selected_charts4</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">#比較プロットを作る</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">)),</span> <span class="n">portfolioChart</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Before Greedy Search&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">)),</span> <span class="n">portfolioChart2</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;After Greedy Search&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">)),</span> <span class="n">portfolioChart3</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;1st Gen Genetic&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">)),</span> <span class="n">portfolioChart4</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Last Gen Genetic&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best Gene 1st generation:
[ 1  1  1  1  1  1 -1  1  1  1  1  1 -1 -1  1  1 -1  1 -1 -1  1  1 -1 -1
 -1  1  1  1  1 -1  1  1 -1 -1  1  1 -1 -1  1  1  1  1  1  1  1  1  1 -1] 1.9747726701605997

Best Gene last generation:
[-1 -1 -1 -1  1 -1  1  1  1 -1  1 -1 -1 -1  1 -1 -1  1 -1  1 -1  1 -1 -1
  1  1  1 -1  1  1  1  1 -1  1 -1  1  1 -1  1  1 -1 -1 -1  1  1 -1 -1 -1] 2.0880009827357706

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_24_1.png" src="../_images/ja_013-ReverseQuantumAnnealing_24_1.png" />
</div>
</div>
</section>
</section>
</section>
<section id="Open-Jijを用いた量子アニーリング手法の実装">
<h2>Open Jijを用いた量子アニーリング手法の実装<a class="headerlink" href="#Open-Jijを用いた量子アニーリング手法の実装" title="Permalink to this headline">¶</a></h2>
<section id="Quantum-Annealingによる解法">
<h3>Quantum Annealingによる解法<a class="headerlink" href="#Quantum-Annealingによる解法" title="Permalink to this headline">¶</a></h3>
<p>Reverse Quantum Annealingでこの最適問題解くために、古典なアルゴリズムで得られたスピン形式の結果をアニーリングが使う形式に変換する。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[221]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ConvertSolutionToQuboState</span><span class="p">(</span><span class="n">solution</span><span class="p">):</span>
    <span class="n">output</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">solution</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">solution</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span>

<span class="n">QA_init_state</span> <span class="o">=</span> <span class="n">ConvertSolutionToQuboState</span><span class="p">(</span><span class="n">Solution</span><span class="p">)</span> <span class="c1">#貪欲サーチの結果を初期状態として使う</span>
<span class="c1">#QA_init_state = ConvertSolutionToQuboState(selected_Genes[0][1]) #遺伝的アルゴリズムラスト世代の最優良ポートフォリオを初期状態として使う</span>
<span class="c1">#QA_init_state = GenerateRandomSolution(Nassets) #ランダムな初期状態を使う</span>
<span class="nb">print</span><span class="p">(</span><span class="n">QA_init_state</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 1, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 1]
</pre></div></div>
</div>
<section id="Forward-Annealingの場合">
<h4>Forward Annealingの場合<a class="headerlink" href="#Forward-Annealingの場合" title="Permalink to this headline">¶</a></h4>
<p>銘柄の魅力度とペアワイズ相関による罰金と賞金の度合を使ってQUBO行列を作り、まずForward Annealingを実行する。最終リターン率の改善はケースバイケースになるが、結果として貪欲サーチの結果よりも安定したチャートを得ている。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[222]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">openjij</span> <span class="kn">import</span> <span class="n">SQASampler</span>
<span class="n">sampler</span> <span class="o">=</span> <span class="n">SQASampler</span><span class="p">()</span>

<span class="n">QUBO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">Nassets</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Nassets</span><span class="p">,</span> <span class="n">Nassets</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nassets</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nassets</span><span class="p">):</span>
        <span class="n">QUBO</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">PairwiseCorrMat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nassets</span><span class="p">):</span>
    <span class="n">QUBO</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">QUBO</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">SR_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">QUBO</span><span class="p">))</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">QUBO</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">sampleset_FQA</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">sample_qubo</span><span class="p">(</span><span class="n">QUBO</span><span class="p">,</span><span class="n">num_reads</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sampleset_FQA</span><span class="o">.</span><span class="n">record</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sampleset_FQA</span><span class="o">.</span><span class="n">record</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">EvaluateSolution</span><span class="p">(</span><span class="n">sampleset_FQA</span><span class="o">.</span><span class="n">record</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">Chart</span><span class="p">))</span>
<span class="n">selected_charts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nassets</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">sampleset_FQA</span><span class="o">.</span><span class="n">record</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
        <span class="n">selected_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Chart</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">portfolioChart_FQA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">selected_charts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">)),</span> <span class="n">portfolioChart_FQA</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Forward Annealing&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">)),</span> <span class="n">portfolioChart</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Before Greedy Search&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">)),</span> <span class="n">portfolioChart2</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;After Greedy Search&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;class &#39;numpy.ndarray&#39;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_28_1.png" src="../_images/ja_013-ReverseQuantumAnnealing_28_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 1, 1, 0, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 1], -341., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 1], -342., 1)]
[0 0 0 1 0 0 1 1 0 1 0 1 0 1 0 0 1 1 1 1 1 0 0 0 0 0 1 1 1 0 1 1 0 1 1 1 0
 0 1 0 1 0 1 1 1 0 0 1] 4.33806400478993
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_28_3.png" src="../_images/ja_013-ReverseQuantumAnnealing_28_3.png" />
</div>
</div>
</section>
<section id="Reverse-Quantum-Annealing(RQA)の場合">
<h4>Reverse Quantum Annealing(RQA)の場合<a class="headerlink" href="#Reverse-Quantum-Annealing(RQA)の場合" title="Permalink to this headline">¶</a></h4>
<p>Reverse Annealingの場合、まずは古典的アルゴリズムから得られた状態を初期状態として入力してからアニーリングを行う。この時はまずアニーリングのスケジュールを設定する必要がある。SQAのハミルトニアンは次のようになる。</p>
<div class="math notranslate nohighlight">
\[\mathcal{H}_{\mathrm{SQA}}(s) = s\mathcal{H}_{p}-(1-s)\sum_{i}\sigma_{i}^{x}, 0\leq x\leq 1\]</div>
<p>ここの<span class="math notranslate nohighlight">\(\mathcal{H}_{p}\)</span>は問題のハミルトニアンで￥、<span class="math notranslate nohighlight">\(s\)</span>と<span class="math notranslate nohighlight">\(1-s\)</span>はそれぞれ参考論文[2]の<span class="math notranslate nohighlight">\(B[t]\)</span>と<span class="math notranslate nohighlight">\(A[t]\)</span>に対応する。この<span class="math notranslate nohighlight">\(s\)</span>の設定は</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sample_qubo</span><span class="p">(</span><span class="n">QUBO</span><span class="p">,</span> <span class="n">num_reads</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>に追加の引数を指定することによってできる。初期状態の設定や更新を含めて</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sample_qubo</span><span class="p">(</span><span class="n">QUBO</span><span class="p">,</span> <span class="n">schedule</span> <span class="o">=</span> <span class="n">user_schedule</span><span class="p">,</span> <span class="n">initial_state</span> <span class="o">=</span> <span class="n">user_initial_state</span><span class="p">,</span> <span class="n">num_reads</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">reinitialize_state</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>のように変更すればよい。ここのscheduleはアニーリングスケジュールを指していて、</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">user_schedule</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="c1">#s=0, beta=0.1, 4 steps</span>
    <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>  <span class="c1">#s=0, beta=1, 4 steps</span>
    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1">#s=1, beta=10, 3 steps</span>
<span class="p">]</span>
</pre></div>
</div>
<p>のような構造を持つ、格納されたリストの<code class="docutils literal notranslate"><span class="pre">[0]</span></code>成分は<span class="math notranslate nohighlight">\(s\)</span>の値で、アニーリングするときの横磁場の強さを反映する。<code class="docutils literal notranslate"><span class="pre">[1]</span></code>成分は逆温度<span class="math notranslate nohighlight">\(\beta\)</span>で、大きければ低い温度を意味し、より強く基底状態に戻る。デフォルトでは<span class="math notranslate nohighlight">\(\beta = 5\)</span>で設定されている。そして最後の<code class="docutils literal notranslate"><span class="pre">[2]</span></code>成分は量子モンテカルロ法のシミュレーションステップ数を表していて、各スケジュールの長さを調整できる。</p>
<p>そして<code class="docutils literal notranslate"><span class="pre">initial_state</span></code>が代入する初期状態である。<code class="docutils literal notranslate"><span class="pre">reinitialize_state</span></code>のオプションが<code class="docutils literal notranslate"><span class="pre">False</span></code>にすることで、毎回実行した出力がまた初期状態として代入されて次のアニーリングを行う意味で、上の関数はある初期状態から出発してRQAを10回イタレーションする意味になる。このオプション引数がデフォルトでは<code class="docutils literal notranslate"><span class="pre">True</span></code>で、実行するたびに初期状態の再設定を行っている。RQAを一回実行させ、複数回の結果を比較したい場合は<code class="docutils literal notranslate"><span class="pre">True</span></code>で問題ない。</p>
<p>ではReverse Annealingのスケジュールを作成する。OpenJijのsamplerは指定された<span class="math notranslate nohighlight">\(s\)</span>と<span class="math notranslate nohighlight">\(\beta\)</span>を指定したMC
stepの数で量子モンテカルロを実行ので、短い定数をつなぎ合わせて<span class="math notranslate nohighlight">\(s\)</span>や<span class="math notranslate nohighlight">\(\beta\)</span>が少しずつ変化するようなスケジュールを作ってRQAの動作を作る必要がある。ここでは<span class="math notranslate nohighlight">\(s\)</span>の変化に注目してそれをプロットすると逆さまの台形のスケジュールを確認できた。横軸は量子モンテカルロ法のステップ数になる。スケジュール作成の関数を書き換えればそのほかの形のスケジュールも簡単に作成できる。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[223]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ScheduleFunction</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">RQAschedule</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">RQAschedule</span><span class="p">:</span>
        <span class="n">length</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">-</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">-</span><span class="n">length</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">ConvertScheduleToPlot</span><span class="p">(</span><span class="n">RQAschedule</span><span class="p">):</span>
    <span class="n">TotalLength</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">RQAschedule</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">TotalLength</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="n">ScheduleFunction</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">RQAschedule</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">s</span> <span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">#Create RQA schedule</span>
<span class="n">RQAschedule</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">NReverseStep</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">NPauseStep</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">NForwardStep</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">NMCStep</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">TargetS</span> <span class="o">=</span> <span class="mf">0.38</span>
<span class="n">ReverseStep</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">TargetS</span><span class="p">)</span> <span class="o">/</span> <span class="n">NReverseStep</span>
<span class="n">ForwardStep</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">TargetS</span><span class="p">)</span> <span class="o">/</span> <span class="n">NForwardStep</span>
<span class="n">beta</span> <span class="o">=</span> <span class="mf">5.</span>
<span class="c1">#Reverse Step</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NReverseStep</span><span class="p">):</span>
    <span class="n">step_sche</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="n">ReverseStep</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">NMCStep</span><span class="p">]</span>
    <span class="n">RQAschedule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_sche</span><span class="p">)</span>

<span class="c1">#Pause Step</span>
<span class="n">RQAschedule</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">TargetS</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">NPauseStep</span><span class="o">*</span><span class="n">NMCStep</span><span class="p">])</span>

<span class="c1">#Forward Step</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NForwardStep</span><span class="p">):</span>
    <span class="n">step_sche</span> <span class="o">=</span> <span class="p">[</span><span class="n">TargetS</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ForwardStep</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">NMCStep</span><span class="p">]</span>
    <span class="n">RQAschedule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_sche</span><span class="p">)</span>

<span class="c1">#Plot Annealing Schedule</span>
<span class="n">ConvertScheduleToPlot</span><span class="p">(</span><span class="n">RQAschedule</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_30_0.png" src="../_images/ja_013-ReverseQuantumAnnealing_30_0.png" />
</div>
</div>
<p>作られたスケジュールを使って、初期状態を指定した<code class="docutils literal notranslate"><span class="pre">sample_qubo</span></code>関数を使って、RQAを実行する。そして同様に、貪欲サーチの結果やForward Annealingの結果ちお比較を行う。結果を見ると、このチュートリアルが行う設定では銘柄セットのサイズ制限によってForward Annealingと同じ最適解にたどり着く場合が多いのが分かる。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[224]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#初期状態を準備</span>
<span class="n">init_state</span> <span class="o">=</span> <span class="n">QA_init_state</span>

<span class="c1">#Reverse Annealing</span>
<span class="n">sampleset_RQA</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">sample_qubo</span><span class="p">(</span><span class="n">QUBO</span><span class="p">,</span> <span class="n">schedule</span><span class="o">=</span><span class="n">RQAschedule</span><span class="p">,</span> <span class="n">initial_state</span> <span class="o">=</span> <span class="n">init_state</span><span class="p">,</span> <span class="n">num_reads</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">reinitialize_state</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sampleset_RQA</span><span class="o">.</span><span class="n">record</span><span class="p">)</span>

<span class="c1">#チャートの比較</span>
<span class="n">selected_charts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nassets</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">sampleset_RQA</span><span class="o">.</span><span class="n">record</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
        <span class="n">selected_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Chart</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">portfolioChart_RQA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">selected_charts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">)),</span> <span class="n">portfolioChart_FQA</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Forward Annealing&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">)),</span> <span class="n">portfolioChart_RQA</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Reverse Annealing&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">)),</span> <span class="n">portfolioChart</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Before Greedy Search&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">)),</span> <span class="n">portfolioChart2</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;After Greedy Search&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1">#結果の比較</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Forward Quantum Annealing Result:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sampleset_FQA</span><span class="o">.</span><span class="n">record</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">EvaluateSolution</span><span class="p">(</span><span class="n">sampleset_FQA</span><span class="o">.</span><span class="n">record</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">Chart</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reverse Quantum Annealing Result:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sampleset_RQA</span><span class="o">.</span><span class="n">record</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">EvaluateSolution</span><span class="p">(</span><span class="n">sampleset_RQA</span><span class="o">.</span><span class="n">record</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">Chart</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1], -342., 1)]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_32_1.png" src="../_images/ja_013-ReverseQuantumAnnealing_32_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Forward Quantum Annealing Result:
[0 0 0 1 0 0 1 1 0 1 0 1 0 1 0 0 1 1 1 1 1 0 0 0 0 0 1 1 1 0 1 1 0 1 1 1 0
 0 1 0 1 0 1 1 1 0 0 1] 4.33806400478993
Reverse Quantum Annealing Result:
[0 0 0 1 0 0 1 1 0 1 0 1 0 1 0 0 1 1 1 1 0 0 0 0 0 0 1 1 1 0 1 1 0 1 1 1 0
 0 1 0 1 1 1 1 1 0 0 1] 4.1030830955703115
</pre></div></div>
</div>
</section>
</section>
<section id="Reverse-Quantum-Annealingの確認">
<h3>Reverse Quantum Annealingの確認<a class="headerlink" href="#Reverse-Quantum-Annealingの確認" title="Permalink to this headline">¶</a></h3>
<p>同じ状態になると、実際にRQAの様子が分からないので、段階を分解してRQAを実行してみる。まずはReverse Phaseの確認である。同じようにアニーリングスケジュールを設定して、スケジュールと初期状態を指定したアニーリングを行う。ここでは例が分かりやすくなるようにReverse
Phaseが止まる<span class="math notranslate nohighlight">\(s\)</span>の値や逆温度の設定を変えた。また、アニーリングもイタレーションではなく、毎回同じ初期状態から始まるように設定した。結果を見ると、逆転したアニーリング過程によって、既に得られた解から、よりエネルギーの高い状態に登っていったことが分かる。また、ほぼ毎回異なる状態でとまるので、高いエネルギー准位で解が定まっていないのもわかる。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[225]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Create RQA schedule</span>
<span class="n">RQAschedule</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">NReverseStep</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">TargetS</span> <span class="o">=</span> <span class="mf">0.15</span> <span class="c1">#よりランダムな状態に戻す</span>
<span class="n">ReverseStep</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">TargetS</span><span class="p">)</span> <span class="o">/</span> <span class="n">NReverseStep</span>
<span class="n">beta</span> <span class="o">=</span> <span class="mf">5.0</span>
<span class="n">MC_step</span> <span class="o">=</span> <span class="mi">20</span>
<span class="c1">#Reverse Step</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NReverseStep</span><span class="p">):</span>
    <span class="n">step_sche</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="n">ReverseStep</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">MC_step</span><span class="p">]</span>
    <span class="n">RQAschedule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_sche</span><span class="p">)</span>

<span class="n">ConvertScheduleToPlot</span><span class="p">(</span><span class="n">RQAschedule</span><span class="p">)</span>
<span class="n">init_state</span> <span class="o">=</span> <span class="n">QA_init_state</span>


<span class="n">sampleset_RQA_Reverse</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">sample_qubo</span><span class="p">(</span><span class="n">QUBO</span><span class="p">,</span> <span class="n">schedule</span><span class="o">=</span><span class="n">RQAschedule</span><span class="p">,</span> <span class="n">initial_state</span> <span class="o">=</span> <span class="n">init_state</span><span class="p">,</span> <span class="n">num_reads</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">reinitialize_state</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#毎回同じ初期状態からアニーリング</span>
<span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">sampleset_RQA_Reverse</span><span class="o">.</span><span class="n">record</span><span class="p">:</span>
    <span class="n">selected_charts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nassets</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">selected_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Chart</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">portfolioChart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">selected_charts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">)),</span> <span class="n">portfolioChart</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Energy=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sampleset_RQA_Reverse</span><span class="o">.</span><span class="n">record</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_34_0.png" src="../_images/ja_013-ReverseQuantumAnnealing_34_0.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_34_1.png" src="../_images/ja_013-ReverseQuantumAnnealing_34_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1], -333., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 1], -332., 1)
 ([0, 0, 0, 1, 0, 1, 1, 0, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 1], -341., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 1, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1], -341., 1)]
</pre></div></div>
</div>
<p>Reverse状態の確認ができたので、このままPause Phaseの追加を行う。追加後は同様にアニーリングを実行して、その結果を確認した。このPhaseの追加は実装上において上のReverse Phaseの一番最後のステップのMCステップ数を伸ばしたものに等しいので、上のReverseのみのケースと同じようにバラバラの結果になる。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[226]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Create Pause Step</span>
<span class="n">NPauseStep</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">TargetS</span> <span class="o">=</span> <span class="mf">0.15</span> <span class="c1">#よりランダムな状態に戻す</span>
<span class="n">beta</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1">#より高い温度で熱的動きがしやすくようにする</span>
<span class="n">MC_step</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">step_sche</span> <span class="o">=</span> <span class="p">[</span><span class="n">TargetS</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">MC_step</span><span class="o">*</span><span class="n">NPauseStep</span><span class="p">]</span>
<span class="n">RQAschedule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_sche</span><span class="p">)</span>

<span class="c1">#print(RQAschedule)</span>
<span class="n">ConvertScheduleToPlot</span><span class="p">(</span><span class="n">RQAschedule</span><span class="p">)</span>
<span class="n">init_state</span> <span class="o">=</span> <span class="n">QA_init_state</span>

<span class="n">sampleset_RQA_Reverse_Pause</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">sample_qubo</span><span class="p">(</span><span class="n">QUBO</span><span class="p">,</span> <span class="n">schedule</span><span class="o">=</span><span class="n">RQAschedule</span><span class="p">,</span> <span class="n">initial_state</span> <span class="o">=</span> <span class="n">init_state</span><span class="p">,</span> <span class="n">num_reads</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">reinitialize_state</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#毎回同じ初期状態からアニーリング</span>
<span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">sampleset_RQA_Reverse_Pause</span><span class="o">.</span><span class="n">record</span><span class="p">:</span>
    <span class="n">selected_charts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nassets</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">selected_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Chart</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">portfolioChart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">selected_charts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">)),</span> <span class="n">portfolioChart</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Energy=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sampleset_RQA_Reverse_Pause</span><span class="o">.</span><span class="n">record</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_36_0.png" src="../_images/ja_013-ReverseQuantumAnnealing_36_0.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_36_1.png" src="../_images/ja_013-ReverseQuantumAnnealing_36_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[([0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 0, 0, 0, 1, 1, 1, 0, 1, 1], -275., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 0, 0, 0, 1, 0, 1, 1, 1, 0, 0, 0, 1, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 0, 0, 1, 0, 1, 0, 1, 0, 0, 1], -257., 1)
 ([0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1], -248., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 1, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 0, 1], -309., 1)
 ([0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 1, 1, 0, 0, 0, 1, 0, 0, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 1], -298., 1)
 ([0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1, 0, 0, 1, 0, 1, 1, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1], -285., 1)
 ([0, 1, 1, 1, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 0, 1, 0, 0, 1], -261., 1)
 ([0, 1, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 1, 1, 0, 1, 0, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 0, 0, 1], -259., 1)
 ([0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 1], -325., 1)
 ([0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 1, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 0, 1, 0, 1], -250., 1)]
</pre></div></div>
</div>
<p>最後にForward Phaseをまた追加してアニーリングを行う。ここの設定はこのチュートリアルの前のサンプルよりも少し緩い温度や磁場の条件で行った。結果として、この銘柄セットで既知の量子アニーリングによる最適解が得られたのが分かる。これでRQAの節の最初の例でもちゃんとRQAによって最適解を出しているのが分かる。</p>
<p>また、条件が少し緩いため、解が収束せずに、エネルギーが近い複数のsub-optimalの解の存在を確認することができる。そのなかは場合によって、量子アニーリングの最適解よりも最終的なリターンが良くて、形も比較的に滑らかなポートフォリオの存在も確認できる。そのポートフォリオの詳細を見ると、その大きなリターンは上昇率が大きい特定の銘柄によるもので、逆相関を持つ変動率が比較的に小さい銘柄と組み合わせて実現されたものだと分かる。実際の投資においてはそのようなポートフォリオが好ましいかもしれないが、このチュートリアルが設定した「Shape
Ratioが特に書く最大になる」条件では、相対的に大きいポートフォリSharpe Ratioが実現されることから、量子アニーリングによって最適ではない解と判断された。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[227]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Create Forward Step</span>
<span class="n">NForwardStep</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">TargetS</span> <span class="o">=</span> <span class="mf">0.15</span> <span class="c1">#よりランダムな状態に戻す</span>
<span class="n">ForwardStep</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">TargetS</span><span class="p">)</span> <span class="o">/</span> <span class="n">NForwardStep</span>
<span class="n">beta</span> <span class="o">=</span> <span class="mf">5.0</span> <span class="c1">#より高い温度で熱的動きがしやすくようにする</span>
<span class="n">MC_step</span> <span class="o">=</span> <span class="mi">20</span>

<span class="c1">#Forward Step</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NForwardStep</span><span class="p">):</span>
    <span class="n">step_sche</span> <span class="o">=</span> <span class="p">[</span><span class="n">TargetS</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ForwardStep</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">MC_step</span><span class="p">]</span>
    <span class="n">RQAschedule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_sche</span><span class="p">)</span>

<span class="n">ConvertScheduleToPlot</span><span class="p">(</span><span class="n">RQAschedule</span><span class="p">)</span>
<span class="n">init_state</span> <span class="o">=</span> <span class="n">QA_init_state</span>

<span class="n">sampleset_RQA_Reverse_Pause_Forward</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">sample_qubo</span><span class="p">(</span><span class="n">QUBO</span><span class="p">,</span> <span class="n">schedule</span><span class="o">=</span><span class="n">RQAschedule</span><span class="p">,</span> <span class="n">initial_state</span> <span class="o">=</span> <span class="n">init_state</span><span class="p">,</span> <span class="n">num_reads</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">reinitialize_state</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#毎回同じ初期状態からアニーリング</span>
<span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">sampleset_RQA_Reverse_Pause_Forward</span><span class="o">.</span><span class="n">record</span><span class="p">:</span>
    <span class="n">selected_charts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nassets</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">selected_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Chart</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">portfolioChart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">selected_charts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">)),</span> <span class="n">portfolioChart</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Energy=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sampleset_RQA_Reverse_Pause_Forward</span><span class="o">.</span><span class="n">record</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_38_0.png" src="../_images/ja_013-ReverseQuantumAnnealing_38_0.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_38_1.png" src="../_images/ja_013-ReverseQuantumAnnealing_38_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1], -342., 1)
 ([0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1], -342., 1)]
</pre></div></div>
</div>
</section>
<section id="RQAスケジュールを指定するときのパラメータ探索">
<h3>RQAスケジュールを指定するときのパラメータ探索<a class="headerlink" href="#RQAスケジュールを指定するときのパラメータ探索" title="Permalink to this headline">¶</a></h3>
<p>Phaseを分けてReverse Quantum Annealingの様子を確認するところで、スケジュールの設定に指定した<span class="math notranslate nohighlight">\(s\)</span>,<span class="math notranslate nohighlight">\(\beta\)</span>そして量子モンテカルロ法のステップ数によって結果が変化することが分かった。つまり、Reverse Annealingでパフォーマンスを良くするには適切な値を設定する必要がある。</p>
<section id="Reverse-Phaseの場合">
<h4>Reverse Phaseの場合<a class="headerlink" href="#Reverse-Phaseの場合" title="Permalink to this headline">¶</a></h4>
<p>まずはそれらがReverse Phaseに対する影響を見る。量子アニーリングの度合を表す<span class="math notranslate nohighlight">\(ssの影響を見る、これは横磁場をどれぐらい強く戻すのかを表す量で、最初のアニーリングで辿り着いたミニマムの周りになるポテンシャル障壁を超えて状態がばらけるようにするために、それを適切に強く（\)</span>s<span class="math notranslate nohighlight">\(を小さく）設定しなければならない。このノートの結果では\)</span>s$が<span class="math notranslate nohighlight">\(0.20\)</span>までReverse
Phaseの終状態のばらつきがあっても不定にはならず、<span class="math notranslate nohighlight">\(0.20\)</span>以下だと熱的揺らぎが支配的になり、ばらつきが大きくなったのが分かる。なので<span class="math notranslate nohighlight">\(0.2\)</span>あたりをさらに細かくスキャンすれば最適の<span class="math notranslate nohighlight">\(s\)</span>値を得られる。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[228]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">TargetS</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)):</span>
    <span class="c1">#Create RQA schedule</span>
    <span class="n">RQAschedule</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">NReverseStep</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">ReverseStep</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">TargetS</span><span class="p">)</span> <span class="o">/</span> <span class="n">NReverseStep</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="mf">5.0</span>
    <span class="n">MC_step</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="c1">#Reverse Step</span>
    <span class="c1">#for i in range(NReverseStep):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NReverseStep</span><span class="p">):</span>
        <span class="n">step_sche</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="n">ReverseStep</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">MC_step</span><span class="p">]</span>
        <span class="n">RQAschedule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_sche</span><span class="p">)</span>

    <span class="n">init_state</span> <span class="o">=</span> <span class="n">QA_init_state</span>


    <span class="n">sampleset_RQA_Reverse</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">sample_qubo</span><span class="p">(</span><span class="n">QUBO</span><span class="p">,</span> <span class="n">schedule</span><span class="o">=</span><span class="n">RQAschedule</span><span class="p">,</span> <span class="n">initial_state</span> <span class="o">=</span> <span class="n">init_state</span><span class="p">,</span> <span class="n">num_reads</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">reinitialize_state</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#毎回同じ初期状態からアニーリング</span>
    <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">sampleset_RQA_Reverse</span><span class="o">.</span><span class="n">record</span><span class="p">:</span>
        <span class="n">selected_charts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nassets</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">selected_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Chart</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">portfolioChart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">selected_charts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">)),</span> <span class="n">portfolioChart</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Energy=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">1.8</span><span class="p">,</span> <span class="s2">&quot;Target s=&quot;</span><span class="o">+</span><span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">TargetS</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_40_0.png" src="../_images/ja_013-ReverseQuantumAnnealing_40_0.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_40_1.png" src="../_images/ja_013-ReverseQuantumAnnealing_40_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_40_2.png" src="../_images/ja_013-ReverseQuantumAnnealing_40_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_40_3.png" src="../_images/ja_013-ReverseQuantumAnnealing_40_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_40_4.png" src="../_images/ja_013-ReverseQuantumAnnealing_40_4.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_40_5.png" src="../_images/ja_013-ReverseQuantumAnnealing_40_5.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_40_6.png" src="../_images/ja_013-ReverseQuantumAnnealing_40_6.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_40_7.png" src="../_images/ja_013-ReverseQuantumAnnealing_40_7.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_40_8.png" src="../_images/ja_013-ReverseQuantumAnnealing_40_8.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_40_9.png" src="../_images/ja_013-ReverseQuantumAnnealing_40_9.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_40_10.png" src="../_images/ja_013-ReverseQuantumAnnealing_40_10.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_40_11.png" src="../_images/ja_013-ReverseQuantumAnnealing_40_11.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_40_12.png" src="../_images/ja_013-ReverseQuantumAnnealing_40_12.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_40_13.png" src="../_images/ja_013-ReverseQuantumAnnealing_40_13.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_40_14.png" src="../_images/ja_013-ReverseQuantumAnnealing_40_14.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_40_15.png" src="../_images/ja_013-ReverseQuantumAnnealing_40_15.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_40_16.png" src="../_images/ja_013-ReverseQuantumAnnealing_40_16.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_40_17.png" src="../_images/ja_013-ReverseQuantumAnnealing_40_17.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_40_18.png" src="../_images/ja_013-ReverseQuantumAnnealing_40_18.png" />
</div>
</div>
<p>次に<span class="math notranslate nohighlight">\(\beta\)</span>による影響を調べる。<span class="math notranslate nohighlight">\(\beta = \frac{1}{k_{\mathrm{B}T}}\)</span>が逆温度を表していて、<span class="math notranslate nohighlight">\(\beta\)</span>が大きければ大きいほど、系がより低温である意味になる。それはつまり全体としては状態がより基底状態に落ちやすく、より「Annealed」な状態に近いふるまいをする。言い換えると横磁場が一定の場合、<span class="math notranslate nohighlight">\(\beta\)</span>が大きくなると、横磁場が効きにくくなり、実効的には大きい<span class="math notranslate nohighlight">\(s\)</span>に近いふるまいになる。OpenJijにおいてその影響の詳細を知りたい方はこの<a class="reference external" href="https://qiita.com/ground0state/items/0f61c3efc7f12fd96d05">Qiita記事</a>に参照してください。</p>
<p>また、その影響はQUBO行列に入っているエネルギーんの典型的なスケール付近で変わることも分かっている。このチュートリアルの場合、QUBOに入っている典型な値は<span class="math notranslate nohighlight">\([-5,5]\)</span>の範囲に入るため、<span class="math notranslate nohighlight">\(\beta=5.0\)</span>付近でふるまいが変化すると予想できある。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[229]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">((</span><span class="n">QUBO</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[229]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(array([  4.,   4.,   4., 640., 504., 504., 624.,   5.,   5.,  10.]),
 array([-14., -11.,  -8.,  -5.,  -2.,   1.,   4.,   7.,  10.,  13.,  16.]),
 &lt;BarContainer object of 10 artists&gt;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_42_1.png" src="../_images/ja_013-ReverseQuantumAnnealing_42_1.png" />
</div>
</div>
<p>対数的な<span class="math notranslate nohighlight">\(\beta\)</span>配列を用意して、<span class="math notranslate nohighlight">\(s\)</span>以外の量を固定してReverse Phaseを行う。予想通り<span class="math notranslate nohighlight">\(\beta=5\)</span>あたりで終状態のばらつきが小さくなり、それよりも大きい<span class="math notranslate nohighlight">\(\beta\)</span>だと数少ない状態に収束してしまうことが分かる。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[230]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">beta</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">2.5</span><span class="p">,</span><span class="mf">5.0</span><span class="p">,</span><span class="mf">10.0</span><span class="p">,</span><span class="mf">20.0</span><span class="p">,</span><span class="mf">50.0</span><span class="p">]:</span>
    <span class="c1">#Create RQA schedule</span>
    <span class="n">RQAschedule</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">NReverseStep</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">TargetS</span> <span class="o">=</span> <span class="mf">0.18</span>
    <span class="n">ReverseStep</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">TargetS</span><span class="p">)</span> <span class="o">/</span> <span class="n">NReverseStep</span>
    <span class="n">MC_step</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="c1">#Reverse Step</span>
    <span class="c1">#for i in range(NReverseStep):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NReverseStep</span><span class="p">):</span>
        <span class="n">step_sche</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="n">ReverseStep</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">MC_step</span><span class="p">]</span>
        <span class="n">RQAschedule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_sche</span><span class="p">)</span>

    <span class="n">init_state</span> <span class="o">=</span> <span class="n">QA_init_state</span>


    <span class="n">sampleset_RQA_Reverse</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">sample_qubo</span><span class="p">(</span><span class="n">QUBO</span><span class="p">,</span> <span class="n">schedule</span><span class="o">=</span><span class="n">RQAschedule</span><span class="p">,</span> <span class="n">initial_state</span> <span class="o">=</span> <span class="n">init_state</span><span class="p">,</span> <span class="n">num_reads</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">reinitialize_state</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#毎回同じ初期状態からアニーリング</span>
    <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">sampleset_RQA_Reverse</span><span class="o">.</span><span class="n">record</span><span class="p">:</span>
        <span class="n">selected_charts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nassets</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">selected_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Chart</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">portfolioChart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">selected_charts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">)),</span> <span class="n">portfolioChart</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Energy=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">1.8</span><span class="p">,</span> <span class="s2">&quot;beta =&quot;</span><span class="o">+</span><span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beta</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_44_0.png" src="../_images/ja_013-ReverseQuantumAnnealing_44_0.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_44_1.png" src="../_images/ja_013-ReverseQuantumAnnealing_44_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_44_2.png" src="../_images/ja_013-ReverseQuantumAnnealing_44_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_44_3.png" src="../_images/ja_013-ReverseQuantumAnnealing_44_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_44_4.png" src="../_images/ja_013-ReverseQuantumAnnealing_44_4.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_44_5.png" src="../_images/ja_013-ReverseQuantumAnnealing_44_5.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_44_6.png" src="../_images/ja_013-ReverseQuantumAnnealing_44_6.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_44_7.png" src="../_images/ja_013-ReverseQuantumAnnealing_44_7.png" />
</div>
</div>
<p>そしてスケジュールの分割について調べる。階段関数のような極端的な場合から、細かく分割して緩やかな変化にする場合まで調査をした。結果から分かるように、分割数が少ない場合、状態があまり変化せず、増やすとばらつきが見えてくる。また、大きく増やしても計算時間が長くなるだけで結果の違いが少ないのも分かる。このチュートリアルが取り扱うポートフォリオ最適化問題の場合は<span class="math notranslate nohighlight">\(50\)</span>程度の設定で問題ない。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[231]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">NReverseStep</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">500</span><span class="p">,</span><span class="mi">1000</span><span class="p">]:</span>
    <span class="c1">#Create RQA schedule</span>
    <span class="n">RQAschedule</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">TargetS</span> <span class="o">=</span> <span class="mf">0.18</span>
    <span class="n">ReverseStep</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">TargetS</span><span class="p">)</span> <span class="o">/</span> <span class="n">NReverseStep</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="mf">5.0</span>
    <span class="n">MC_step</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="c1">#Reverse Step</span>
    <span class="c1">#for i in range(NReverseStep):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NReverseStep</span><span class="p">):</span>
        <span class="n">step_sche</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="n">ReverseStep</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">MC_step</span><span class="p">]</span>
        <span class="n">RQAschedule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_sche</span><span class="p">)</span>

    <span class="n">init_state</span> <span class="o">=</span> <span class="n">QA_init_state</span>


    <span class="n">sampleset_RQA_Reverse</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">sample_qubo</span><span class="p">(</span><span class="n">QUBO</span><span class="p">,</span> <span class="n">schedule</span><span class="o">=</span><span class="n">RQAschedule</span><span class="p">,</span> <span class="n">initial_state</span> <span class="o">=</span> <span class="n">init_state</span><span class="p">,</span> <span class="n">num_reads</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">reinitialize_state</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#毎回同じ初期状態からアニーリング</span>
    <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">sampleset_RQA_Reverse</span><span class="o">.</span><span class="n">record</span><span class="p">:</span>
        <span class="n">selected_charts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nassets</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">selected_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Chart</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">portfolioChart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">selected_charts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">)),</span> <span class="n">portfolioChart</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Energy=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">1.8</span><span class="p">,</span> <span class="s2">&quot;NReverseStep =&quot;</span><span class="o">+</span><span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">NReverseStep</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_46_0.png" src="../_images/ja_013-ReverseQuantumAnnealing_46_0.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_46_1.png" src="../_images/ja_013-ReverseQuantumAnnealing_46_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_46_2.png" src="../_images/ja_013-ReverseQuantumAnnealing_46_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_46_3.png" src="../_images/ja_013-ReverseQuantumAnnealing_46_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_46_4.png" src="../_images/ja_013-ReverseQuantumAnnealing_46_4.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_46_5.png" src="../_images/ja_013-ReverseQuantumAnnealing_46_5.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_46_6.png" src="../_images/ja_013-ReverseQuantumAnnealing_46_6.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_46_7.png" src="../_images/ja_013-ReverseQuantumAnnealing_46_7.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_46_8.png" src="../_images/ja_013-ReverseQuantumAnnealing_46_8.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_46_9.png" src="../_images/ja_013-ReverseQuantumAnnealing_46_9.png" />
</div>
</div>
<p>またMC stepsに関しては、分割数×MC stepsが極端に少ない場合でなければ、最終の結果にはほぼ影響がないことが分かる。<code class="docutils literal notranslate"><span class="pre">SQASampler()</span></code>がデフォルト設定の場合、目安として<span class="math notranslate nohighlight">\(1000\)</span>程度で問題なく動作するはずである。</p>
</section>
<section id="Pause-Phaseの場合">
<h4>Pause Phaseの場合<a class="headerlink" href="#Pause-Phaseの場合" title="Permalink to this headline">¶</a></h4>
<p>既に説明があったように、通常の場合Pause PhaseがReverse Phaseの最後のステップを延長させたものに違いないので、アニーリング全体の<span class="math notranslate nohighlight">\(s\)</span>と<span class="math notranslate nohighlight">\(\beta\)</span>を変化させたところで、Reverse Phaseと同じようなふるまいをする。また、ステップ数もどのぐらい最後のステップを伸ばすのかに等しい意味なので、変更してもほぼReverse Phaseの状態を保持したままだけで、影響が少ない。</p>
<p>ただし、Pause Phaseだけ<span class="math notranslate nohighlight">\(\beta\)</span>を変化させることは量子アニーリングが不完全な状態で古典的なアニーリングを行うの近い行動である。ここでは<span class="math notranslate nohighlight">\(\beta=5.0\)</span>から緩やかに目標とした<span class="math notranslate nohighlight">\(\beta\)</span>に向かって系の温度を変化させて、その影響を調べる。そして、Reverse Phaseで異なる<span class="math notranslate nohighlight">\(\beta\)</span>でアニーリングを行った場合の終状態に近い結果を得られた。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[232]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">beta</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">2.5</span><span class="p">,</span><span class="mf">5.0</span><span class="p">,</span><span class="mf">10.0</span><span class="p">,</span><span class="mf">20.0</span><span class="p">,</span><span class="mf">50.0</span><span class="p">]:</span>
    <span class="c1">#Create RQA schedule</span>
    <span class="n">RQAschedule</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">NReverseStep</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">TargetS</span> <span class="o">=</span> <span class="mf">0.18</span>
    <span class="n">ReverseStep</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">TargetS</span><span class="p">)</span> <span class="o">/</span> <span class="n">NReverseStep</span>
    <span class="n">MC_step</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="c1">#Reverse Step</span>
    <span class="c1">#for i in range(NReverseStep):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NReverseStep</span><span class="p">):</span>
        <span class="n">step_sche</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="n">ReverseStep</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">MC_step</span><span class="p">]</span>
        <span class="n">RQAschedule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_sche</span><span class="p">)</span>

    <span class="c1">#Pause Phase</span>
    <span class="n">NPauseStep</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">betaStep</span> <span class="o">=</span> <span class="p">(</span><span class="mf">5.0</span><span class="o">-</span><span class="n">beta</span><span class="p">)</span> <span class="o">/</span> <span class="n">NPauseStep</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NReverseStep</span><span class="p">):</span>
        <span class="n">step_sche</span> <span class="o">=</span> <span class="p">[</span><span class="n">TargetS</span><span class="p">,</span> <span class="mf">5.0</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="n">betaStep</span><span class="p">,</span> <span class="n">MC_step</span><span class="p">]</span>
        <span class="n">RQAschedule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_sche</span><span class="p">)</span>

    <span class="n">init_state</span> <span class="o">=</span> <span class="n">QA_init_state</span>


    <span class="n">sampleset_RQA_Reverse_Pause</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">sample_qubo</span><span class="p">(</span><span class="n">QUBO</span><span class="p">,</span> <span class="n">schedule</span><span class="o">=</span><span class="n">RQAschedule</span><span class="p">,</span> <span class="n">initial_state</span> <span class="o">=</span> <span class="n">init_state</span><span class="p">,</span> <span class="n">num_reads</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">reinitialize_state</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#毎回同じ初期状態からアニーリング</span>
    <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">sampleset_RQA_Reverse_Pause</span><span class="o">.</span><span class="n">record</span><span class="p">:</span>
        <span class="n">selected_charts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nassets</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">selected_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Chart</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">portfolioChart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">selected_charts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">)),</span> <span class="n">portfolioChart</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Energy=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">1.8</span><span class="p">,</span> <span class="s2">&quot;Target beta =&quot;</span><span class="o">+</span><span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beta</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_49_0.png" src="../_images/ja_013-ReverseQuantumAnnealing_49_0.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_49_1.png" src="../_images/ja_013-ReverseQuantumAnnealing_49_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_49_2.png" src="../_images/ja_013-ReverseQuantumAnnealing_49_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_49_3.png" src="../_images/ja_013-ReverseQuantumAnnealing_49_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_49_4.png" src="../_images/ja_013-ReverseQuantumAnnealing_49_4.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_49_5.png" src="../_images/ja_013-ReverseQuantumAnnealing_49_5.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_49_6.png" src="../_images/ja_013-ReverseQuantumAnnealing_49_6.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_49_7.png" src="../_images/ja_013-ReverseQuantumAnnealing_49_7.png" />
</div>
</div>
</section>
<section id="Forward-Phaseの場合">
<h4>Forward Phaseの場合<a class="headerlink" href="#Forward-Phaseの場合" title="Permalink to this headline">¶</a></h4>
<p>Forwar PhaseはReverse PhaseとPause Phaseで得られた状態から普通の量子アニーリングを行う。このとき考えるぺきパラメータの条件は通常のアニーリングが正しく動作するために必要な条件と基本同じである。Reverse PhaseとPause Phaseと同じ方法で、<span class="math notranslate nohighlight">\(\beta\)</span>と分割したステップ数のスキャンを行った結果、比較的に小さい分割数と<span class="math notranslate nohighlight">\(\beta\)</span>でも結果がちゃんと最適解に収束することが分かった。</p>
<p>下のコードはその例である。Reverse PhaseとPause Phaseは上の調査で得られた設定で、Forward Phaseだけ粗い分解と小さい<span class="math notranslate nohighlight">\(\beta\)</span>でアニーリングを行っている。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[233]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Create RQA schedule</span>
<span class="n">RQAschedule</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">NReverseStep</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">TargetS</span> <span class="o">=</span> <span class="mf">0.18</span>
<span class="n">ReverseStep</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">TargetS</span><span class="p">)</span> <span class="o">/</span> <span class="n">NReverseStep</span>
<span class="n">MC_step</span> <span class="o">=</span> <span class="mi">20</span>
<span class="c1">#Reverse Step</span>
<span class="c1">#for i in range(NReverseStep):</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NReverseStep</span><span class="p">):</span>
    <span class="n">step_sche</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="n">ReverseStep</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">MC_step</span><span class="p">]</span>
    <span class="n">RQAschedule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_sche</span><span class="p">)</span>

<span class="c1">#Pause Phase</span>
<span class="n">NPauseStep</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">step_sche</span> <span class="o">=</span> <span class="p">[</span><span class="n">TargetS</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">MC_step</span><span class="o">*</span><span class="n">NPauseStep</span><span class="p">]</span>
<span class="n">RQAschedule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_sche</span><span class="p">)</span>

<span class="c1">#Forward Phase</span>
<span class="n">NForwardStep</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">ForwardStep</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">TargetS</span><span class="p">)</span> <span class="o">/</span> <span class="n">NForwardStep</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NForwardStep</span><span class="p">):</span>
    <span class="n">step_sche</span> <span class="o">=</span> <span class="p">[</span><span class="n">TargetS</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ForwardStep</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="n">MC_step</span><span class="p">]</span>
    <span class="n">RQAschedule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_sche</span><span class="p">)</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="n">QA_init_state</span>

<span class="n">sampleset_RQA_Reverse_Pause_Forward</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">sample_qubo</span><span class="p">(</span><span class="n">QUBO</span><span class="p">,</span> <span class="n">schedule</span><span class="o">=</span><span class="n">RQAschedule</span><span class="p">,</span> <span class="n">initial_state</span> <span class="o">=</span> <span class="n">init_state</span><span class="p">,</span> <span class="n">num_reads</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">reinitialize_state</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#毎回同じ初期状態からアニーリング</span>
<span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">sampleset_RQA_Reverse_Pause_Forward</span><span class="o">.</span><span class="n">record</span><span class="p">:</span>
    <span class="n">selected_charts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nassets</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">selected_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Chart</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">portfolioChart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">selected_charts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">)),</span> <span class="n">portfolioChart</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Energy=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">1.8</span><span class="p">,</span> <span class="s2">&quot;NForwardStep =&quot;</span><span class="o">+</span><span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">NForwardStep</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/ja_013-ReverseQuantumAnnealing_51_0.png" src="../_images/ja_013-ReverseQuantumAnnealing_51_0.png" />
</div>
</div>
</section>
</section>
</section>
<section id="終わりに">
<h2>終わりに<a class="headerlink" href="#終わりに" title="Permalink to this headline">¶</a></h2>
<p>以上のように、OpenJijを用いて、Reverse Quantum Annealingを実装してポートフォリオ最適化問題を解いた。このチュートリアルをは、RQAの問題定式化やスケジュール指定のやり方、そしてRQAを行う時考慮すべきパラメータなどの説明を行った。また結果として、RQAの手法を用いることで、正しく最適解となる答えを得られることを示した。</p>
<p>ほかの最適解付近にsub-optimalな解が多く存在する問題に関しても、同様な手法でより良い解を求められるので、通常の量子アニーリングでローカルミニマムにハマった時、このようにReverse Quantum Annealingを試して見ると解決できるかもしれない。</p>
<p>また、例えばスケジュールの変化が線形関数から非線形な形にした場合の影響など、RQAについてこのチュートリアルで議論しなかった部分もあるが、このチュートリアルにあるコードを変更することで簡単にできるので、興味がある方は是非試してみてください。</p>
<section id="付録A-シミュレーションの結果が上手くいかない場合">
<h3>付録A シミュレーションの結果が上手くいかない場合<a class="headerlink" href="#付録A-シミュレーションの結果が上手くいかない場合" title="Permalink to this headline">¶</a></h3>
<p>このチュートリアルで使用された銘柄セットの生成コードは必ずしても構成が「良い」銘柄を生成する保証がないので、場合によって偏った分布を持ったセットに対して実験する可能性もある。その時は、遺伝的アルゴリズムの計算が非常に長い時間を持つことや、チュートリアルがデフォルトで使用した<span class="math notranslate nohighlight">\(s\)</span>や<span class="math notranslate nohighlight">\(\beta\)</span>などのパラメータでRQAが収束しないこともある。そうした場合は銘柄セットを再生成するか、手動でRQAのパラメータ調整を行って最適解に収束するようにしてください。</p>
</section>
<section id="付録B-DwaveマシンでRQA実験をする場合のコード">
<h3>付録B DwaveマシンでRQA実験をする場合のコード<a class="headerlink" href="#付録B-DwaveマシンでRQA実験をする場合のコード" title="Permalink to this headline">¶</a></h3>
<p>Dwaveマシンにおいてもこのチュートリアルが実行した手法でRQAを実行できる。ここでは参考としてそのサンプルコードを載せる。実装及びシミュレーションと実機の違いで、スケジュールの設定方法や引数が異なるが、基本的には同じような過程になる。詳細を知りたい方はDwave公式サイトなどにあるドキュメントに参考してください。 また、実機では現実のノイズなどによる影響は見られやすいので通常のアニーリングとRQAによる結果の違いは見られやすい。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dwave.system</span> <span class="kn">import</span> <span class="n">DWaveSampler</span><span class="p">,</span> <span class="n">EmbeddingComposite</span>

<span class="n">token</span> <span class="o">=</span> <span class="s1">&#39;*** your user token ***&#39;</span>
<span class="n">endpoint</span> <span class="o">=</span> <span class="s1">&#39;*** your dwave endpoint***&#39;</span> <span class="c1">#&#39;https://cloud.dwavesys.com/sapi/&#39; as defaults</span>

<span class="n">dw_sampler</span> <span class="o">=</span> <span class="n">DWaveSampler</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;Advantage_system4.1&#39;</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
<span class="n">sampler</span> <span class="o">=</span> <span class="n">EmbeddingComposite</span><span class="p">(</span><span class="n">dw_sampler</span><span class="p">)</span>

<span class="n">Nassets</span> <span class="o">=</span> <span class="mi">48</span>


<span class="c1"># RQA schedule</span>
<span class="n">timing</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="c1">#各フェーズの開始と終了時刻、フェーズの数を増やしても問題ない</span>
<span class="n">Ratio</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">0.38</span><span class="p">,</span><span class="mf">0.38</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span><span class="c1">#各フェーズが変わる時のs</span>
<span class="n">schedule</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">timing</span><span class="p">,</span><span class="n">Ratio</span><span class="p">))</span><span class="c1">#スケジュールにまとめる</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timing</span><span class="p">,</span><span class="n">Ratio</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">#Create QUBO</span>
<span class="n">QUBO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">Nassets</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Nassets</span><span class="p">,</span> <span class="n">Nassets</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>  <span class="nb">range</span><span class="p">(</span><span class="n">Nassets</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nassets</span><span class="p">):</span>
        <span class="n">QUBO</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">pairwise_corr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nassets</span><span class="p">):</span>
    <span class="n">QUBO</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">QUBO</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">SR_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">QUBO</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">#FQA</span>
<span class="n">sampleset</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">sample_qubo</span><span class="p">(</span><span class="n">QUBO</span><span class="p">,</span><span class="n">num_reads</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sampleset</span><span class="o">.</span><span class="n">record</span><span class="p">)</span>

<span class="n">min_forword</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">sampleset</span><span class="o">.</span><span class="n">record</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_forword</span><span class="p">:</span>
        <span class="n">min_forword</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">best_forword</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">selected_charts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nassets</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">best_forword</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
        <span class="n">selected_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Chart</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">portfolioChart_FQA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">selected_charts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">)),</span> <span class="n">portfolioChart_FQA</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Forward Annealing&quot;</span><span class="p">)</span>

<span class="c1">#RQA</span>
<span class="n">sampleset_RQA</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">sample_qubo</span><span class="p">(</span><span class="n">QUBO</span><span class="p">,</span><span class="n">num_reads</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>  <span class="n">anneal_schedule</span><span class="o">=</span><span class="n">schedule</span><span class="p">,</span> <span class="n">initial_state</span> <span class="o">=</span> <span class="n">QA_init_state</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sampleset_RQA</span><span class="o">.</span><span class="n">record</span><span class="p">)</span>

<span class="n">min_RQA</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">sampleset_RQA</span><span class="o">.</span><span class="n">record</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_RQA</span><span class="p">:</span>
        <span class="n">min_RQA</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">best_RQA</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">selected_charts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nassets</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">best_RQA</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
        <span class="n">selected_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Chart</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">portfolioChart_RQA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">selected_charts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">)),</span> <span class="n">portfolioChart_RQA</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Reverse Annealing&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
</section>
</section>
<section id="参考文献">
<h2>参考文献<a class="headerlink" href="#参考文献" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p>Harry Markowitz, “Portfolio selection”, The journal of finance, 7(1):77–91 (1952)</p></li>
<li><p>Davide Venturelli, Alexei Kondratyev, “Reverse Quantum Annealing Approach to Portfolio Optimization Problems”, Quantum Machine Intelligence volume 1, pages17–30 (2019)</p></li>
<li><p>Sharpe, William F., “Mutual fund performance”, The Journal of Business 39 (1), 119-138 (1966)</p></li>
</ol>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">13 Reverse Quantum Annealing with Portfolio Optimization Problem as an example</a><ul>
<li><a class="reference internal" href="#ポートフォリオ最適化問題">ポートフォリオ最適化問題</a></li>
<li><a class="reference internal" href="#Reverse-Quantum-Annealingによるポートフォリオ最適化">Reverse Quantum Annealingによるポートフォリオ最適化</a><ul>
<li><a class="reference internal" href="#Reverse-Quantum-Annealing">Reverse Quantum Annealing</a></li>
<li><a class="reference internal" href="#Reverse-Quantum-Annealingによるポートフォリオ最適化の手順">Reverse Quantum Annealingによるポートフォリオ最適化の手順</a></li>
</ul>
</li>
<li><a class="reference internal" href="#銘柄データの生成と古典アルゴリズムの実装">銘柄データの生成と古典アルゴリズムの実装</a><ul>
<li><a class="reference internal" href="#最適化を行う銘柄データの生成">最適化を行う銘柄データの生成</a></li>
<li><a class="reference internal" href="#古典アルゴリズムによる探索">古典アルゴリズムによる探索</a><ul>
<li><a class="reference internal" href="#貪欲サーチ">貪欲サーチ</a></li>
<li><a class="reference internal" href="#遺伝的アルゴリズム">遺伝的アルゴリズム</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#Open-Jijを用いた量子アニーリング手法の実装">Open Jijを用いた量子アニーリング手法の実装</a><ul>
<li><a class="reference internal" href="#Quantum-Annealingによる解法">Quantum Annealingによる解法</a><ul>
<li><a class="reference internal" href="#Forward-Annealingの場合">Forward Annealingの場合</a></li>
<li><a class="reference internal" href="#Reverse-Quantum-Annealing(RQA)の場合">Reverse Quantum Annealing(RQA)の場合</a></li>
</ul>
</li>
<li><a class="reference internal" href="#Reverse-Quantum-Annealingの確認">Reverse Quantum Annealingの確認</a></li>
<li><a class="reference internal" href="#RQAスケジュールを指定するときのパラメータ探索">RQAスケジュールを指定するときのパラメータ探索</a><ul>
<li><a class="reference internal" href="#Reverse-Phaseの場合">Reverse Phaseの場合</a></li>
<li><a class="reference internal" href="#Pause-Phaseの場合">Pause Phaseの場合</a></li>
<li><a class="reference internal" href="#Forward-Phaseの場合">Forward Phaseの場合</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#終わりに">終わりに</a><ul>
<li><a class="reference internal" href="#付録A-シミュレーションの結果が上手くいかない場合">付録A シミュレーションの結果が上手くいかない場合</a></li>
<li><a class="reference internal" href="#付録B-DwaveマシンでRQA実験をする場合のコード">付録B DwaveマシンでRQA実験をする場合のコード</a></li>
</ul>
</li>
<li><a class="reference internal" href="#参考文献">参考文献</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="012-ProteinFoldingHubo.html"
                        title="previous chapter">12-Solving Protein Folding Problem by HUBO Solver</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="A001-Introduction.html"
                        title="next chapter">A1 - OpenJij core interface入門 (core python interface)</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/ja/013-ReverseQuantumAnnealing.ipynb.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="A001-Introduction.html" title="A1 - OpenJij core interface入門 (core python interface)"
             >next</a> |</li>
        <li class="right" >
          <a href="012-ProteinFoldingHubo.html" title="12-Solving Protein Folding Problem by HUBO Solver"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">OpenJij Tutorial 0.3.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >OpenJij チュートリアル</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">13 Reverse Quantum Annealing with Portfolio Optimization Problem as an example</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, Jij Inc..
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.0.1.
    </div>
  </body>
</html>